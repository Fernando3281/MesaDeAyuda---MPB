<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/plantilla :: head}">
        <title>Mensajes - Mesa de Ayuda</title>
        <link th:href="@{/css/mensajes_layout_principal.css}" rel="stylesheet" />
    </head>
    <body>
        <header th:replace="~{layout/plantilla :: header}"></header>
        <section th:fragment="mensajes-section" class="mensajes-section container mt-4">
            <h1 class="mensajes-title">Mis Mensajes</h1>

            <div class="mensajes-content">
                <!-- Panel lateral con lista de tickets -->
                <div class="tickets-list">
                    <div th:if="${tickets.empty}" class="empty-ticket-message">
                        No hay tickets con mensajes disponibles.
                    </div>
                    <div class="ticket-item" 
                         th:each="ticket : ${tickets}"
                         th:id="'ticket-' + ${ticket.idTicket}"
                         th:classappend="${ticket == selectedTicket ? 'active' : ''}"
                         th:onclick="'loadMessages(' + ${ticket.idTicket} + ', this)'">
                        <span class="ticket-code" th:text="${ticket.codigo}">TICKET-001</span>
                        <span class="ticket-title" th:text="${ticket.titulo}">Problema con impresora</span>
                        <div class="ticket-metadata">
                            <span class="ticket-status" th:text="${ticket.estado}">Estado</span>
                            <span class="ticket-date" th:text="${#dates.format(ticket.fechaActualizacion, 'dd/MM/yyyy')}">01/01/2025</span>
                        </div>
                    </div>
                </div>

                <!-- Área de visualización de mensajes -->
                <div class="messages-area">
                    <div class="messages-header" th:if="${selectedTicket != null}">
                        <h2 class="ticket-title-main" th:text="${selectedTicket.titulo}">Título del Ticket</h2>
                        <div class="ticket-details">
                            <span>Estado: <strong th:text="${selectedTicket.estado}">Estado</strong></span>
                            <span>Prioridad: <strong th:text="${selectedTicket.prioridad}">Prioridad</strong></span>
                            <span>Categoría: <strong th:text="${selectedTicket.categoria}">Categoría</strong></span>
                        </div>
                    </div>

                    <div class="messages-header" th:if="${selectedTicket == null}">
                        <h2>Seleccione un ticket para ver los mensajes</h2>
                    </div>

                    <div class="messages-list" id="messagesList" th:if="${selectedTicket != null}">
                        <div class="no-messages" id="noMessagesPlaceholder">
                            Seleccione un ticket para ver los mensajes
                        </div>
                    </div>

                    <!-- Área de entrada de mensajes -->
                    <div class="message-input-area" th:if="${selectedTicket != null}">
                        <div class="message-input-container">
                            <textarea id="messageInput" class="message-input" placeholder="Escribe tu mensaje aquí..." rows="1"></textarea>
                            <button id="sendButton" class="send-button">Enviar</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Función para formatear la fecha con icono
                function formatDateWithIcon(dateString) {
                    const date = new Date(dateString);
                    const formattedDate = date.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `<i class="fa-regular fa-clock" style="margin-right: 5px;"></i>${formattedDate}`;
                }

                // Función para cargar los mensajes de un ticket
                function loadMessages(ticketId, element) {
                    // Mostrar indicador de carga
                    const messagesList = document.getElementById('messagesList');
                    messagesList.innerHTML = '<div class="no-messages">Cargando mensajes...</div>';

                    // Realizar la petición AJAX
                    fetch('/mensajes/cargar/' + ticketId)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Error al cargar los mensajes');
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    renderMessages(data.mensajes);

                                    // Actualizar el ticket activo
                                    document.querySelectorAll('.ticket-item').forEach(item => {
                                        item.classList.remove('active');
                                    });
                                    element.classList.add('active');

                                    // Actualizar el encabezado con información del ticket
                                    const header = document.querySelector('.messages-header h2');
                                    if (header) {
                                        header.textContent = data.ticket.titulo;
                                    }

                                    // Hacer scroll al final de los mensajes
                                    messagesList.scrollTop = messagesList.scrollHeight;
                                } else {
                                    showError(data.error || 'Error al cargar los mensajes');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showError('Error al cargar los mensajes. Por favor intente nuevamente.');
                            });
                }

                // Función para renderizar los mensajes en el contenedor
                function renderMessages(messages) {
                    const messagesList = document.getElementById('messagesList');

                    if (messages.length === 0) {
                        messagesList.innerHTML = '<div class="no-messages">No hay mensajes en este ticket.</div>';
                        return;
                    }

                    messagesList.innerHTML = '';

                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = message.esMio ? 'message-container my-message' : 'message-container other-message';

                        // Avatar del emisor
                        const avatar = document.createElement('img');
                        avatar.className = 'message-avatar';
                        avatar.src = '/usuario/imagen/' + message.emisor.id;
                        avatar.alt = message.emisor.nombre;

                        const contentWrapper = document.createElement('div');
                        contentWrapper.className = 'message-content-wrapper';

                        const messageContent = document.createElement('div');
                        messageContent.className = 'message-content';

                        // Cabecera del mensaje (emisor y fecha)
                        const messageHeader = document.createElement('div');
                        messageHeader.className = 'message-header';

                        const senderName = document.createElement('span');
                        senderName.className = 'sender-name';
                        senderName.textContent = message.emisor.nombre;

                        const messageTime = document.createElement('span');
                        messageTime.className = 'message-time';
                        messageTime.innerHTML = formatDateWithIcon(message.fecha);

                        messageHeader.appendChild(senderName);
                        messageHeader.appendChild(messageTime);

                        // Contenido del mensaje
                        const messageText = document.createElement('div');
                        messageText.className = 'message-text';
                        messageText.textContent = message.contenido;

                        // Nota interna (si aplica)
                        if (message.esNotaInterna) {
                            messageContent.classList.add('internal-note');
                            const internalNote = document.createElement('span');
                            internalNote.className = 'internal-note-badge';
                            internalNote.textContent = 'Nota Interna';
                            messageHeader.appendChild(internalNote);
                        }

                        messageContent.appendChild(messageHeader);
                        messageContent.appendChild(messageText);
                        contentWrapper.appendChild(messageContent);

                        // Añadir elementos al mensaje (orden depende de si es propio o ajeno)
                        if (message.esMio) {
                            messageDiv.appendChild(contentWrapper);
                            messageDiv.appendChild(avatar);
                        } else {
                            messageDiv.appendChild(avatar);
                            messageDiv.appendChild(contentWrapper);
                        }

                        messagesList.appendChild(messageDiv);
                    });
                }

                // Función para mostrar errores
                function showError(message) {
                    const messagesList = document.getElementById('messagesList');
                    messagesList.innerHTML = `<div class="no-messages" style="color: #f44336;">${message}</div>`;
                }

                // Función para enviar mensaje
                function sendMessage() {
                    const messageInput = document.getElementById('messageInput');
                    const message = messageInput.value.trim();
                    
                    if (message === '') return;
                    
                    const sendButton = document.getElementById('sendButton');
                    sendButton.disabled = true;
                    
                    // Obtener el ticket activo
                    const activeTicket = document.querySelector('.ticket-item.active');
                    if (!activeTicket) {
                        showError('No hay un ticket seleccionado');
                        return;
                    }
                    
                    const ticketId = activeTicket.id.replace('ticket-', '');
                    
                    // Enviar el mensaje al servidor
                    fetch('/mensajes/enviar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ticketId: ticketId,
                            contenido: message
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Limpiar el input
                            messageInput.value = '';
                            // Recargar los mensajes
                            loadMessages(ticketId, activeTicket);
                        } else {
                            showError(data.error || 'Error al enviar el mensaje');
                        }
                        sendButton.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showError('Error al enviar el mensaje. Por favor intente nuevamente.');
                        sendButton.disabled = false;
                    });
                }

                // Event listeners
                document.addEventListener('DOMContentLoaded', function () {
                    // Cargar mensajes del ticket seleccionado si hay uno en la URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const ticketId = urlParams.get('ticketId');
                    if (ticketId) {
                        const ticketElement = document.getElementById('ticket-' + ticketId);
                        if (ticketElement) {
                            loadMessages(ticketId, ticketElement);
                        }
                    }
                    
                    // Configurar el botón de enviar
                    const sendButton = document.getElementById('sendButton');
                    if (sendButton) {
                        sendButton.addEventListener('click', sendMessage);
                    }
                    
                    // Configurar el textarea para enviar con Enter
                    const messageInput = document.getElementById('messageInput');
                    if (messageInput) {
                        messageInput.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                sendMessage();
                            }
                        });
                        
                        // Autoajustar altura del textarea
                        messageInput.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = (this.scrollHeight) + 'px';
                        });
                    }
                });
            </script>
        </section>
    </body>
</html>