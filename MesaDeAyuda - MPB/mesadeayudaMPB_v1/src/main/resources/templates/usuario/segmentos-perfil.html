<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/plantilla :: head}">
        <title>Mesa de Ayuda</title>
    </head>

    <body>
        <section th:fragment="historial">
            <meta name="_csrf" th:content="${_csrf.token}"/>
            <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
            <div class="ticket-list-container">
                <div class="ticket-list-header">
                    <div class="header-left">
                        <h2>Historial de Tickets</h2>
                        <div class="ticket-counter">
                            <span class="counter-number" id="ticketCounter">0</span>
                            <span class="counter-label">tickets disponibles</span>
                        </div>
                    </div>
                    <div class="search-filter">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" placeholder="Buscar por título, ID o descripción...">
                        </div>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter="status">
                            <span>Estado</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="priority">
                            <span>Prioridad</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="category">
                            <span>Categoría</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="date">
                            <span>Fecha</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <button class="button clear-filters" id="clearFilters">
                        Limpiar filtros
                    </button>
                </div>

                <div class="active-filters" id="activeFilters">
                    <!-- Filtros Activos -->
                </div>

                <!-- Filter Dropdowns -->
                <div class="filter-dropdown" id="statusFilter">
                    <div class="dropdown-content">
                        <label><input type="checkbox" name="status" value="abierto" checked> Abierto</label>
                        <label><input type="checkbox" name="status" value="en-proceso" checked> En Proceso</label>
                        <label><input type="checkbox" name="status" value="cerrado" checked> Cerrado</label>
                    </div>
                </div>

                <div class="filter-dropdown" id="priorityFilter">
                    <div class="dropdown-content">
                        <label><input type="checkbox" name="priority" value="alta" checked> Alta</label>
                        <label><input type="checkbox" name="priority" value="media" checked> Media</label>
                        <label><input type="checkbox" name="priority" value="baja" checked> Baja</label>
                    </div>
                </div>

                <div class="filter-dropdown" id="categoryFilter">
                    <div class="dropdown-content">
                        <label><input type="checkbox" name="category" value="hardware" checked> Hardware</label>
                        <label><input type="checkbox" name="category" value="software" checked> Software</label>
                        <label><input type="checkbox" name="category" value="redes" checked> Redes</label>
                        <label><input type="checkbox" name="category" value="sistemas" checked> Sistemas</label>
                    </div>
                </div>

                <div class="filter-dropdown" id="dateFilter">
                    <div class="dropdown-content date-range">
                        <div class="date-input-group">
                            <label>Desde:</label>
                            <input type="date" id="dateFrom">
                        </div>
                        <div class="date-input-group">
                            <label>Hasta:</label>
                            <input type="date" id="dateTo">
                        </div>
                        <button class="button apply-date">Aplicar</button>
                    </div>
                </div>

                <div class="ticket-list" id="ticketList">
                    <!-- Mostrar tickets si existen -->
                    <div th:each="ticket : ${tickets}" class="ticket-card" 
                         th:data-id="${ticket.idTicket}" 
                         th:data-priority="${ticket.prioridad}" 
                         th:data-category="${ticket.categoria}" 
                         th:data-status="${ticket.estado}">
                        <div class="ticket-meta">
                            <div class="ticket-header">
                                <span class="ticket-id">
                                    <i class="fas fa-ticket"></i> 
                                    <span th:text="${ticket.codigo}">TIC001</span>
                                </span>
                                <div class="ticket-tags">
                                    <span class="status" 
                                          th:classappend="${'status-' + ticket.estado.toLowerCase().replace(' ', '-')}" 
                                          th:text="${ticket.estado == 'Abierto' ? 'En Revisión' 
                                          : (ticket.estado == 'Pendiente' ? 'En Progreso' 
                                          : (ticket.estado == 'Resuelto' ? 'Solucionado' 
                                          : ticket.estado))}">
                                        Estado
                                    </span>
                                    <span class="priority" th:classappend="${'priority-' + ticket.prioridad.toLowerCase().replace(' ', '-')}">
                                        <i class="fa-solid fa-flag"></i>
                                        <span th:text="${ticket.prioridad}">Prioridad</span>
                                    </span>
                                </div>
                            </div>
                            <span class="date">
                                Fecha: <span th:text="${#dates.format(ticket.fechaApertura, 'dd-MM-yyyy')}">24-08-2024</span>
                            </span>
                        </div>
                        <div class="ticket-content">
                            <h3 th:text="${ticket.titulo}">Título del Ticket</h3>
                            <p th:text="${ticket.descripcion != null ? (#strings.length(ticket.descripcion) > 100 ? #strings.substring(ticket.descripcion,0,100) + '...' : ticket.descripcion) : ''}">Descripción del ticket...</p>
                        </div>
                        <div class="ticket-footer">
                            <div class="category-tag">
                                <i class="fa-solid fa-tag"></i>
                                <span th:text="${ticket.categoria}">Categoría</span>
                            </div>
                            <div class="footer-buttons">
                                <button class="button-32" th:onclick="|window.location.href='@{/usuario/detalles/{id}(id=${ticket.idTicket})}'|">Ver Detalles</button>
                                <button class="button-32 cancel-button" th:if="${ticket.estado == 'Abierto' and ticket.asignadoPara == null}">Cancelar</button>
                            </div>
                        </div>
                    </div>
                    <!-- Componente mejorado para mostrar cuando no hay tickets -->
                    <div th:unless="${not tickets.empty}" class="no-tickets-message">
                        <div class="no-tickets-content">
                            <div class="no-tickets-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="no-tickets-info">
                                <h3>No tienes tickets en tu historial</h3>
                                <p>Tu espacio de trabajo está vacío. Cuando crees un ticket de soporte, aparecerá en esta sección para su respectivo seguimiento.</p>
                            </div>
                            <div class="no-tickets-actions">
                                <a th:href="@{/tickets/nuevo}" class="create-ticket-btn">
                                    <i class="fas fa-plus-circle"></i>
                                    <span>Crear nuevo ticket</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de confirmación para cancelar ticket -->
<div id="cancelTicketModal" class="file-modal" style="display: none;">
    <div class="modal-container" style="text-align: center; padding: 30px;">
        <h3>
            ¿Estás seguro de cancelar el ticket: 
            <span id="ticketToCancelCode" style="color: #4f46e5; font-weight: bold;"></span>?
        </h3>
        <p>El ticket <strong id="ticketToCancelTitle"></strong> será marcado como cancelado. Esta acción no se puede deshacer.</p>
        <div style="margin-top: 20px;">
            <button id="confirmCancel" class="btn btn-primary">Confirmar</button>
            <button id="closeCancelModal" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>
</div>
        </section>

        <section th:fragment="ticket-detalle">
            <meta name="_csrf" th:content="${_csrf.token}"/>
            <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
            <div class="back-button-container" style="margin-bottom: 15px;">
                <a onclick="window.location.href = '/usuario/historial'" class="btn btn-outline-secondary back-button">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <h2 id="Title" style="margin: initial;">Detalles del Ticket</h2>
            </div>

            <div class="main-container">
                <div class="ticket-details">
                    <div class="ticket-header">
                        <div class="ticket-id"><i class="fas fa-ticket"></i> <span th:text="${ticket.codigo}">#TIC00000000</span></div>
                        <span id="status-badge" th:class="${'status-' + 
                              (ticket.estado == 'Abierto' ? 'en-revision' : 
                              ticket.estado == 'Pendiente' ? 'en-progreso' : 
                              ticket.estado == 'Resuelto' ? 'solucionado' : 
                              ticket.estado == 'Desactivado' ? 'desactivado' : 
                              ticket.estado == 'Cancelado' ? 'cancelado' : 
                              'cerrado')}">
                            <i th:class="${ticket.estado == 'Abierto' ? 'far fa-clock' : 
                               ticket.estado == 'Pendiente' ? 'fa-solid fa-arrows-rotate' : 
                               ticket.estado == 'Resuelto' ? 'fas fa-check-circle' : 
                               ticket.estado == 'Desactivado' ? 'fas fa-ban' : 
                               ticket.estado == 'Cancelado' ? 'fas fa-times-circle' : 
                               'fas fa-lock'}"></i>
                            <span th:text="${ticket.estado == 'Abierto' ? 'En Revisión' : 
                                  ticket.estado == 'Pendiente' ? 'En Progreso' : 
                                  ticket.estado == 'Resuelto' ? 'Solucionado' : 
                                  ticket.estado == 'Desactivado' ? 'Desactivado' : 
                                  ticket.estado == 'Cancelado' ? 'Cancelado' : 
                                  'Cerrado'}">Estado</span>
                        </span>
                    </div>
                    <div class="ticket-title" th:text="${ticket.titulo}">Titulo...</div>
                    <p class="ticket-description" th:text="${ticket.descripcion}">
                        Descripcion...
                    </p>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Fecha de Apertura:</label>
                            <div th:text="${#dates.format(ticket.fechaApertura, 'dd MMMM yyyy - HH:mm:ss')}">24 de Agosto del 2024 - 13:45:12</div>
                        </div>
                        <div class="info-item">
                            <label>Prioridad:</label>
                            <div th:text="${ticket.prioridad}">Sin Asignar</div>
                        </div>
                        <div class="info-item">
                            <label>Encargado:</label>
                            <div th:if="${ticket.asignadoPara != null}" 
                                 th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">
                                Sin Asignar
                            </div>
                            <div th:unless="${ticket.asignadoPara != null}">Sin Asignar</div>
                        </div>
                        <div class="info-item">
                            <label>Última Actualización:</label>
                            <div th:text="${#dates.format(ticket.fechaActualizacion, 'dd MMMM yyyy - HH:mm:ss')}">24 de Agosto del 2024 - 13:45:12</div>
                        </div>
                        <div class="info-item">
                            <label>Categoría:</label>
                            <div th:text="${ticket.categoria}">Sistemas</div>
                        </div>
                    </div>

                    <!-- Sección de adjuntos -->
                    <div class="attachments" th:if="${not #lists.isEmpty(imagenes)}">
                        <div class="attachments-header">
                            <label>ARCHIVOS ADJUNTOS</label>
                        </div>
                        <div class="files-grid">
                            <div th:each="imagen : ${imagenes}" class="file-item" 
                                 th:data-src="@{/archivos/ver/{id}(id=${imagen.idArchivo})}"
                                 th:data-type="${imagen.tipoArchivo.startsWith('image/') ? 'image' : 'pdf'}"
                                 th:data-filename="${imagen.nombreArchivo}">
                                <i th:class="${imagen.tipoArchivo.startsWith('image/') ? 'far fa-file-image file-icon' : 'far fa-file-pdf file-icon'}"></i>
                                <span class="file-name" th:text="${imagen.nombreArchivo}">ImagenEjemplo.jpg</span>
                            </div>
                        </div>
                    </div>

                    <!-- Nueva sección de botón de cancelar -->
                    <div class="cancel-section" 
                         th:if="${ticket.estado == 'Abierto'
                         and ticket.asignadoPara == null}">
                        <div class="cancel-button-container">
                            <button class="btn cancel-button">
                                <i class="fa-solid fa-trash-can"></i> Cancelar Solicitud
                            </button>
                        </div>
                    </div>
                </div>


                <div class="manager-info">
                    <h2>Información del Encargado</h2>

                    <!-- Mostrar información solo si hay un soportista asignado -->
                    <div th:if="${ticket.asignadoPara != null}" class="manager-content">
                        <!-- Foto y nombre del soportista -->
                        <div class="agent-profile">
                            <div class="agent-photo">
                                <img th:if="${ticket.asignadoPara.imagen != null}" 
                                     th:src="@{/usuario/imagen/{id}(id=${ticket.asignadoPara.idUsuario})}" 
                                     alt="Foto de perfil">
                                    <i th:unless="${ticket.asignadoPara.imagen != null}" class="fas fa-user-circle"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-role">Equipo de Soporte</div>
                                <div class="agent-name" th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">Nombre del Soportista</div>
                            </div>
                        </div>

                        <!-- Campos de información -->
                        <div class="info-field">
                            <label>Codigo de Identificación</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.codigo}" placeholder="ID">
                        </div>

                        <div class="info-field">
                            <label>Departamento</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.departamento}" placeholder="Departamento">
                        </div>

                        <div class="info-field">
                            <label>Numero de Teléfono</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.numeroTelefono}" placeholder="Telefono no disponible">
                        </div>

                        <div class="info-field">
                            <label>Correo Electrónico</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.correoElectronico}" placeholder="Sin correo registrado">
                        </div>

                        <!-- Contador de tickets -->
                        <div class="tickets-counter">
                            <div class="counter-label">Total de Tickets Atendidos</div>
                            <div class="counter-value">
                                <i class="fas fa-ticket-alt"></i>
                                <!-- Aquí necesitarías agregar un método que cuente tickets atendidos por este soportista para el usuario actual -->
                                <span th:text="${ticketsAtendidos != null ? ticketsAtendidos : '0'}">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mostrar mensaje cuando no hay soportista asignado -->
                    <div th:unless="${ticket.asignadoPara != null}" class="manager-content">
                        <div class="manager-icon">
                            <i th:class="${ticket.estado == 'Cancelado' ? 'fas fa-times-circle' : 
                               ticket.estado == 'Resuelto' ? 'fas fa-check-circle' : 
                               ticket.estado == 'Desactivado' ? 'fas fa-ban' : 
                               ticket.estado == 'Cerrado' ? 'fas fa-lock' : 
                               'fas fa-headset'}"></i>
                        </div>
                        <div class="manager-status">
                            <strong th:text="${ticket.estado == 'Abierto' ? 'Su ticket está en revisión.' : 
                                    ticket.estado == 'Pendiente' ? 'Su ticket está en progreso.' : 
                                    ticket.estado == 'Resuelto' ? 'Su ticket ha sido solucionado.' : 
                                    ticket.estado == 'Cancelado' ? 'Su ticket ha sido cancelado.' :
                                    ticket.estado == 'Desactivado' ? 'Su ticket ha sido desactivado.' :
                                    ticket.estado == 'Cerrado' ? 'Su ticket ha sido cerrado.' :
                                    'Su ticket ha sido cerrado.'}">Estado del ticket</strong>
                            <p th:text="${ticket.estado == 'Cancelado' ? 'Su solicitud ha sido cancelada. Si necesita asistencia o tiene alguna consulta, puede crear un nuevo ticket.' : 
                               ticket.estado == 'Resuelto' ? 'Su solicitud ha sido resuelto exitosamente. Si persiste algún inconveniente, puede crear un nuevo ticket.' :
                               ticket.estado == 'Desactivado' ? 'Su ticket ha sido desactivado. Para obtener soporte, por favor cree un nuevo ticket.' :
                               ticket.estado == 'Cerrado' ? 'Su ticket ha sido cerrado. Si necesita asistencia adicional, puede crear un nuevo ticket.' :
                               'Pronto un soportista se pondrá en contacto con usted.'}">Mensaje del ticket</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de confirmación para cancelar ticket -->
            <div id="cancelTicketModal" class="file-modal" style="display: none;">
                <div class="modal-container" style="text-align: center; padding: 30px;">
                    <h3>¿Estás seguro de cancelar este ticket?</h3>
                    <p>El ticket será marcado como cancelado. Esta accion no se puede deshacer</p>
                    <div style="margin-top: 20px;">
                        <button id="confirmCancel" class="btn btn-primary">Confirmar</button>
                        <button id="closeCancelModal" class="btn btn-secondary">Cerrar</button>
                    </div>
                </div>
            </div>

            <!-- Modal para vista previa de archivos -->
            <div id="fileModal" class="file-modal">
                <span class="close-modal"><i class="fa-solid fa-xmark"></i></span>
                <div class="modal-content-container">
                    <!-- Contenedor para imágenes -->
                    <img id="modalFileImage" class="modal-content" style="display: none;">
                        <!-- Contenedor para PDFs -->
                        <iframe id="modalFilePdf" class="modal-content" style="width: 1300px;; height: 90vh; display: block; border: none;"></iframe>
                        <div id="modalFileName" class="file-name-modal"></div>
                </div>
            </div>
        </section>


        <section th:fragment="usuarios-listado">

            <!-- Mensaje de Exito -->
            <div th:if="${mensaje}" class="alert alert-success" role="alert">
                <span th:text="${mensaje}"></span>
            </div>

            <div class="container-fluid">
                <div class="search-section">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Buscar por nombre, código, correo, teléfono..." 
                               id="searchInput" th:value="${searchQuery}">
                    </div>
                    <div class="action-buttons">
                        <!-- Filtro por estado -->
                        <select id="statusFilter" class="status-filter">
                            <option value="">Todos los estados</option>
                            <option value="activo" th:selected="${estadoFiltro == 'activo'}">Activos</option>
                            <option value="inactivo" th:selected="${estadoFiltro == 'inactivo'}">Inactivos</option>
                        </select>

                        <!-- Nuevo filtro por rol -->
                        <select id="roleFilter" class="status-filter">
                            <option value="">Todos los roles</option>
                            <option value="ROL_ADMINISTRADOR" th:selected="${rolFiltro == 'ROL_ADMINISTRADOR'}">Administradores</option>
                            <option value="ROL_SOPORTISTA" th:selected="${rolFiltro == 'ROL_SOPORTISTA'}">Soportistas</option>
                            <option value="ROL_USUARIO" th:selected="${rolFiltro == 'ROL_USUARIO'}">Usuarios</option>
                        </select>

                        <button id="btnCreateUser" class="btn btn-primary" onclick="openNeonModal('neonCreateModal')">
                            <i class="fas fa-plus"></i> Agregar Nuevo Usuario
                        </button>
                    </div>
                </div>

                <!-- Pagination Header -->
                <div class="table-header">
                    <div class="pagination-left">
                        <span>Mostrar</span>
                        <select id="recordsPerPage" class="records-select">
                            <option value="15" th:selected="${pageSize == 15}">15</option>
                            <option value="30" th:selected="${pageSize == 30}">30</option>
                            <option value="50" th:selected="${pageSize == 50}">50</option>
                            <option value="100" th:selected="${pageSize == 100}">100</option>
                        </select>
                        <span>registros por página</span>
                    </div>
                    <div class="pagination-center">
                        <span id="pageInfo" th:text="'Mostrando ' + ${start} + ' a ' + ${end} + ' de ' + ${totalItems} + ' registros'">
                            Mostrando 1 a 10 de 50 registros
                        </span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=0,size=${pageSize})} + '\''"
                                th:disabled="${currentPage == 0}">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${currentPage-1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage == 0}">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <div class="page-numbers" id="pageNumbers">
                            <button th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                                    th:class="'page-number ' + ${pageNum == currentPage ? 'active' : ''}"
                                    th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${pageNum},size=${pageSize})} + '\''"
                                    th:text="${pageNum + 1}">1</button>
                        </div>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${currentPage+1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage >= totalPages - 1}">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${totalPages-1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage >= totalPages - 1}">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Contenedor de la Tabla -->
                <div class="table-container">
                    <table class="tickets-table table-resizable">
                        <thead>
                            <tr>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">ID</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Imagen</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Código</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Nombre Completo</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Correo Electrónico</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Departamento</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Teléfono</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Roles</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Estado</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Última Conexión</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Acciones</div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario : ${usuarios}">
                                <td th:text="${usuario.idUsuario}"></td>
                                <td style="padding: 2px;">
                                    <img th:if="${usuario.imagen != null}" 
                                         th:src="@{/usuario/imagen/{id}(id=${usuario.idUsuario})}" 
                                         class="user-img" style="width: 35px; height: 35px; display: block; margin: 0 auto;">
                                        <span th:unless="${usuario.imagen != null}" class="badge badge-desactivado" style="display: block; text-align: center;">Sin imagen</span>
                                </td>
                                <td th:text="${usuario.codigo} ?: 'Sin código'"></td>
                                <td th:text="${usuario.nombre + (usuario.apellido != null and !usuario.apellido.isEmpty() ? ' ' + usuario.apellido : '')}"></td>
                                <td th:text="${usuario.correoElectronico} ?: 'Sin correo...'"></td>
                                <td th:text="${usuario.departamento} ?: 'Sin dpto...'"></td>
                                <td th:text="${usuario.numeroTelefono != null} ? ${usuario.numeroTelefono} : 'Sin Numero...'"></td>
                                <td>
                                    <th:block th:if="${#lists.isEmpty(usuario.roles)}">
                                        <span class="badge badge-desactivado">Sin rol...</span>
                                    </th:block>
                                    <span th:each="rol : ${usuario.roles}" 
                                          th:text="${rol.nombre}" 
                                          class="badge badge-abierto"></span>
                                </td>
                                <td>
                                    <span th:text="${usuario.activo ? 'Activo' : 'Inactivo'}" 
                                          th:class="${usuario.activo ? 'badge badge-resuelto' : 'badge badge-cancelado'}"></span>
                                </td>
                                <td th:text="${usuario.ultimaConexion != null} ? ${#dates.format(usuario.ultimaConexion, 'dd/MM/yyyy HH:mm:ss')} : 'Sin conexión'"></td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        <!-- Botón Editar -->
                                        <button th:if="${(usuarioLogueado.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0) || (usuario.idUsuario == usuarioLogueado.idUsuario)}" 
                                                class="btn" style="padding: 4px 8px;" 
                                                th:data-id="${usuario.idUsuario}" 
                                                data-action="edit">
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        <!-- Botón Eliminar -->
                                        <a th:if="${(usuarioLogueado.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0) &amp;&amp; (usuario.idUsuario != usuarioLogueado.idUsuario)}" 
                                           th:href="@{'/usuario/eliminar/' + ${usuario.idUsuario}}" 
                                           class="btn" style="padding: 4px 8px;">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(usuarios)}">
                                <td colspan="11" style="text-align: center;">No se encontraron usuarios en el sistema</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal para Crear Usuario -->
            <div id="neonCreateModal" class="neon-modal">
                <div class="neon-modal-content">
                    <div class="neon-modal-header">
                        <h5 class="modal-title">Agregar Nuevo Usuario</h5>
                        <span class="close-modal" onclick="closeNeonModal('neonCreateModal')">&times;</span>
                    </div>
                    <div class="neon-modal-body">
                        <form id="formCreateUser" th:action="@{/usuario/crear}" method="post" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="nombre">Nombre: <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="apellido">Apellido:</label>
                                        <input type="text" class="form-control" id="apellido" name="apellido" placeholder="Opcional">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label for="correoElectronico">Correo Electrónico: <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="correoElectronico" name="correoElectronico" required>
                            </div>
                            <div class="form-group mb-3">
                                <label for="departamento">Departamento: <span class="text-danger">*</span></label>
                                <select class="form-control" id="departamento" name="departamento" required>
                                    <option value="">Seleccionar departamento</option>
                                    <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep}"></option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label for="contrasena">Contraseña: <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="contrasena" name="contrasena" required minlength="3">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="numeroTelefono">Teléfono:</label>
                                        <input type="text" class="form-control" id="numeroTelefono" name="numeroTelefono" placeholder="Opcional">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="rol">Rol:</label>
                                        <select class="form-control" id="rol" name="rol">
                                            <option value="ROL_USUARIO" selected>Usuario</option>
                                            <option value="ROL_ADMINISTRADOR">Administrador</option>
                                            <option value="ROL_SOPORTISTA">Soportista</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label for="imagenFile">Imagen de Perfil:</label>
                                <input type="file" class="form-control" id="imagenFile" name="imagenFile" accept="image/*">
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="activo" name="activo" checked>
                                    <label class="form-check-label" for="activo">Usuario Activo</label>
                            </div>
                            <div class="neon-modal-footer">
                                <button type="button" class="btn btn-secondary" id="close-modal" onclick="closeNeonModal('neonCreateModal')">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal para Editar Usuario -->
            <div id="neonEditModal" class="neon-modal">
                <div class="neon-modal-content">
                    <div class="neon-modal-header">
                        <h5 class="modal-title">Editar Usuario</h5>
                        <span class="close-modal" onclick="closeNeonModal('neonEditModal')">&times;</span>
                    </div>
                    <div class="neon-modal-body">
                        <form id="formEditUser" th:action="@{/usuario/actualizar}" method="post" enctype="multipart/form-data">
                            <input type="hidden" id="editUserId" name="idUsuario">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editNombre">Nombre:</label>
                                            <input type="text" class="form-control" id="editNombre" name="nombre" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editApellido">Apellido:</label>
                                            <input type="text" class="form-control" id="editApellido" name="apellido">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="editCorreoElectronico">Correo Electrónico:</label>
                                    <input type="email" class="form-control" id="editCorreoElectronico" name="correoElectronico" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editDepartamento">Departamento:</label>
                                            <select class="form-control" id="editDepartamento" name="departamento">
                                                <option value="">Seleccionar departamento</option>
                                                <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editNumeroTelefono">Teléfono:</label>
                                            <input type="text" class="form-control" id="editNumeroTelefono" name="numeroTelefono">
                                        </div>
                                    </div>
                                </div>
                                <!-- En el modal de edición -->
                                <div class="form-group mb-3">
                                    <label for="editContrasena">Contraseña (dejar en blanco para mantener la actual):</label>
                                    <input type="password" class="form-control" id="editContrasena" name="contrasena">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="editImagenFile">Imagen de Perfil:</label>
                                    <input type="file" class="form-control" id="editImagenFile" name="imagenFile" accept="image/*">
                                        <div id="currentImageContainer" class="mt-2" style="display: none;">
                                            <p>Imagen actual:</p>
                                            <img id="currentImage" src="" alt="Imagen actual" style="max-width: 100px; max-height: 100px;">
                                        </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="editRol">Rol:</label>
                                    <select class="form-control" id="editRol" name="rol">
                                        <option value="ROL_ADMINISTRADOR">Administrador</option>
                                        <option value="ROL_SOPORTISTA">Soportista</option>
                                        <option value="ROL_USUARIO">Usuario</option>
                                    </select>
                                </div>
                                <div class="form-check mb-3">
                                    <input type="checkbox" class="form-check-input" id="editActivo" name="activo">
                                        <label class="form-check-label" for="editActivo">Usuario Activo</label>
                                </div>
                                <div class="neon-modal-footer">
                                    <button type="button" class="btn btn-secondary" id="close-modal" onclick="closeNeonModal('neonEditModal')">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal para Confirmar Eliminación -->
            <div id="neonDeleteModal" class="neon-modal">
                <div class="neon-modal-content" style="max-width: 500px;">
                    <div class="neon-modal-header">
                        <h5 class="modal-title">Confirmar Eliminación</h5>
                        <span class="close-modal" onclick="closeNeonModal('neonDeleteModal')">&times;</span>
                    </div>
                    <div class="neon-modal-body">
                        <p>¿Está seguro que desea eliminar al usuario <span id="deleteUserName" class="font-weight-bold"></span>?</p>
                        <p class="text-danger">Esta acción no se puede deshacer.</p>
                        <form id="formDeleteUser" method="post">
                            <input type="hidden" id="deleteUserId" name="id">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <div class="neon-modal-footer">
                                    <button type="button" class="btn btn-secondary" id="close-modal" onclick="closeNeonModal('neonDeleteModal')">Cancelar</button>
                                    <button type="submit" class="btn btn-danger">Eliminar</button>
                                </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Global Loader -->
            <div id="globalLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
                <div style="color: white; font-size: 24px;">
                    <i class="fas fa-spinner fa-spin"></i> Procesando...
                </div>
            </div>

            <!-- Toast de Éxito -->
            <div id="toast-success" class="toast-modal toast-success">
                <div class="toast-content">
                    <p class="toast-message">
                        <i class="toast-icon fas fa-check-circle"></i>
                        <span>Operación exitosa</span>
                    </p>
                    <span class="toast-close">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>

            <!-- Toast de Error -->
            <div id="toast-error" class="toast-modal toast-error">
                <div class="toast-content">
                    <p class="toast-message">
                        <i class="toast-icon fas fa-exclamation-circle"></i>
                        <span>Ocurrió un error</span>
                    </p>
                    <span class="toast-close">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>
        </section>
    </body>
</html>