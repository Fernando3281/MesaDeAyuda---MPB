<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/plantilla :: head}">
        <title>Centro de Soporte</title>
    </head>
    <body>
        <section th:fragment="perfil-section">
            <h2 id="Title">Mi Perfil</h2>
            <div class="profile-card">
                <div class="profile-header">
                    <div class="image-upload-container">
                        <label>
                            <img th:src="@{/usuario/imagen/{id}(id=${usuario.idUsuario})}" alt="Imagen de perfil">
                        </label>
                        <input type="file" 
                               id="imagenFile" 
                               name="imagenFile" 
                               accept="image/*" 
                               style="display: none"
                               onchange="previewImage(this)">
                    </div>
                    <div class="profile-info">
                        <p id="infoUsuario">
                            <span th:if="${#lists.contains(usuario.roles.![nombre], 'ROL_ADMINISTRADOR')}">Administrador</span>
                            <span th:if="${#lists.contains(usuario.roles.![nombre], 'ROL_SOPORTISTA')}">Soportista</span>
                            <span th:if="${#lists.contains(usuario.roles.![nombre], 'ROL_USUARIO') 
                                  and not #lists.contains(usuario.roles.![nombre], 'ROL_ADMINISTRADOR') 
                                  and not #lists.contains(usuario.roles.![nombre], 'ROL_SOPORTISTA')}">Usuario</span>
                        </p>
                        <div id="infoUsuario">
                            <h3 style="display: inline;" th:text="${usuario.nombre} + ${usuario.apellido != null ? ' ' + usuario.apellido : ''}"></h3>
                            <p style="display: inline;" th:text="'ID#' + ${usuario.codigo}"></p>
                        </div>
                        <p id="infoUsuario">
                            <b>Departamento:</b> 
                            <span th:text="${usuario.departamento != null and !usuario.departamento.isEmpty()} ? ${usuario.departamento} : 'Sin Información...'"></span>
                        </p>
                        <p id="infoUsuario">
                            <b>Último Acceso al Sistema:</b>
                            <span th:if="${ultimaConexion != null}" 
                                  th:text="${#temporals.format(ultimaConexion, 'EEEE, d ''de'' MMMM ''de'' yyyy', new java.util.Locale('es', 'ES'))}">
                            </span>
                            <span th:unless="${ultimaConexion != null}">
                                Sin información
                            </span>
                        </p>
                    </div>
                    <button class="btn-update" onclick="window.location.href = '/usuario/editar'">
                        <i class="fa-regular fa-pen-to-square"></i> Actualizar Perfil
                    </button>
                </div>
                <div class="profile-details">
                    <div class="detail-row">
                        <div class="detail-column">
                            <label>Provincia</label>
                            <input type="text" th:value="${usuario.provincia}" placeholder="Sin Informacion..." readonly>
                        </div>
                        <div class="detail-column">
                            <label>Dirección</label>
                            <textarea class="form-control" style="height: 140%;" readonly th:text="${usuario.direccion}" placeholder="Sin Informacion..."></textarea>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-column" id="columnaTelefono">
                            <label>Número de Teléfono</label>
                            <input type="text" id="inputTelefono" 
                                   th:if="${usuario.numeroTelefono != null and usuario.numeroTelefono != ''}" 
                                   th:value="${'+506 ' + usuario.numeroTelefono}" 
                                   readonly>
                            <input type="text" id="inputTelefono" 
                                   th:unless="${usuario.numeroTelefono != null and usuario.numeroTelefono != ''}" 
                                   placeholder="Sin Informacion..."
                                   readonly>
                        </div>
                    </div>
                    <div class="detail-row" style="margin-bottom: 0rem;">
                        <div class="detail-column">
                            <label>Departamento</label>
                            <input type="text" th:value="${usuario.departamento}" placeholder="Sin Informacion..." readonly>
                        </div>
                        <div class="detail-column">
                            <label>Correo Electrónico</label>
                            <input type="text" th:value="${usuario.correoElectronico}" placeholder="Sin Informacion..." readonly>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section th:fragment="tickets-section">
            <h2 class="title-recent-ticket mb-3" onclick="window.location.href = '/usuario/historial'">
                Tickets Recientes
                <i class="fa-solid fa-chevron-right hover-arrow"></i>
            </h2>
            <div class="ticket-list">
                <div th:each="ticketMap : ${ticketsConAdjuntos}" 
                     class="ticket-item" 
                     th:classappend="'status-' + ${#strings.toLowerCase(ticketMap.ticket.estado).replace(' ', '-')}"
                     th:onclick="|window.location.href='@{/usuario/detalles/}${ticketMap.ticket.idTicket}'|"
                     style="cursor: pointer;">

                    <div class="ticket-header">
                        <span class="ticket-id">
                            <div class="ticket-codigo">
                                <i class="fa-solid fa-ticket"></i>
                                <span th:text="${ticketMap.ticket.codigo}">TIC12345678</span>
                            </div>
                            <span class="ticket-attachments" th:if="${ticketMap.tieneArchivos}">
                                <i class="fa-solid fa-paperclip"></i>
                                <span>Archivos Adjuntados</span>
                            </span>
                        </span>
                    </div>

                    <div class="ticket-title" th:text="${ticketMap.ticket.titulo}">Título del ticket</div>

                    <div class="ticket-description" th:text="${ticketMap.ticket.descripcion}">
                        Descripción completa del ticket que será truncada a dos líneas si es muy larga.
                    </div>

                    <div class="ticket-details">
                        <div class="ticket-info">
                            <span class="ticket-property">
                                <i class="fa-solid fa-tag"></i> Categoría: 
                            </span>
                            <span class="ticket-value" th:text="${ticketMap.ticket.categoria}">Categoría</span>
                        </div>

                        <div class="ticket-info">
                            <span class="ticket-property">
                                <i class="fa-solid fa-flag"></i> Prioridad: 
                            </span>
                            <span class="ticket-value" th:text="${ticketMap.ticket.prioridad}">Prioridad</span>
                        </div>

                        <div class="ticket-date">
                            <i class="far fa-calendar-alt"></i>
                            <span th:text="${#dates.format(ticketMap.ticket.fechaApertura, 'dd-MM-yyyy')}">Fecha</span>
                        </div>
                    </div>

                    <div class="ticket-status">
                        <th:block th:with="esUsuario=${#lists.contains(usuario.roles.![nombre], 'ROL_USUARIO') 
                                  and not #lists.contains(usuario.roles.![nombre], 'ROL_ADMINISTRADOR') 
                                  and not #lists.contains(usuario.roles.![nombre], 'ROL_SOPORTISTA')}">

                            <i th:class="${ticketMap.ticket.estado == 'Abierto'} ? 'far fa-clock' : 
                               (${ticketMap.ticket.estado == 'Pendiente'} ? 'fa-solid fa-arrows-rotate' : 
                               (${ticketMap.ticket.estado == 'Resuelto'} ? 'fas fa-check-circle' :
                               (${ticketMap.ticket.estado == 'Cerrado'} ? 'fas fa-lock' :
                               (${ticketMap.ticket.estado == 'Cancelado'} ? 'fas fa-times-circle' :
                               (${ticketMap.ticket.estado == 'Desactivado'} ? 'fas fa-ban' : 'far fa-question-circle')))))"></i>

                            <span th:if="${esUsuario}" 
                                  th:text="${ticketMap.ticket.estado == 'Abierto'} ? 'En Revisión' : 
                                  (${ticketMap.ticket.estado == 'Pendiente'} ? 'En Progreso' : 
                                  (${ticketMap.ticket.estado == 'Resuelto'} ? 'Solucionado' : ${ticketMap.ticket.estado}))">
                                Estado
                            </span>
                            <span th:unless="${esUsuario}" th:text="${ticketMap.ticket.estado}">
                                Estado
                            </span>
                        </th:block>
                    </div>
                </div>

                <div th:if="${ticketsConAdjuntos == null or ticketsConAdjuntos.empty}" class="no-tickets">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <h3>No tienes tickets recientes</h3>
                        <p>No se encontraron tickets en tu historial reciente.</p>
                    </div>
                </div>
            </div>
        </section>

        <section th:fragment="perfil-section-editar">
            <h2 id="Title">Editar Perfil</h2>

            <div id="emailSentModal" class="toast-modal toast-success" style="display: none;">
                <div class="toast-content">
                    <p class="toast-message">
                        <i class="toast-icon fa-solid fa-envelope-circle-check"></i>
                        <span>Se ha enviado un enlace de cambio de contraseña a tu correo electrónico. Por favor revisa tu bandeja de entrada.</span>
                    </p>
                    <span class="toast-close" onclick="closeModal('emailSentModal')">
                        <i class="fa-solid fa-xmark"></i>
                    </span>
                </div>
            </div>

            <form th:action="@{/usuario/guardar}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="idUsuario" th:value="${usuario.idUsuario}">
                <input type="hidden" name="codigo" th:value="${usuario.codigo}">
                <input type="hidden" name="activo" th:value="${usuario.activo}">

                <div class="profile-card">
                    <div class="profile-header">
                        <div class="image-upload-container">
                            <img th:src="@{/usuario/imagen/{id}(id=${usuario.idUsuario})}" 
                                 th:alt="${usuario.nombre}" 
                                 id="preview-image"
                                 onerror="this.src='https://via.placeholder.com/120x120/e9ecef/666?text=Usuario'">
                            <label for="imagenFile" class="image-upload-label">
                                <i class="fa-solid fa-camera"></i>
                            </label>
                            <input type="file" 
                                   id="imagenFile" 
                                   name="imagenFile" 
                                   accept="image/*" 
                                   style="display: none"
                                   onchange="previewImage(this)">
                        </div>

                        <div class="profile-info">
                            <p id="infoUsuario">
                                <span th:if="${#lists.contains(usuario.roles.![nombre], 'ROL_ADMINISTRADOR')}">Administrador</span>
                                <span th:if="${#lists.contains(usuario.roles.![nombre], 'ROL_SOPORTISTA')}">Soportista</span>
                                <span th:if="${#lists.contains(usuario.roles.![nombre], 'ROL_USUARIO') 
                                      and not #lists.contains(usuario.roles.![nombre], 'ROL_ADMINISTRADOR') 
                                      and not #lists.contains(usuario.roles.![nombre], 'ROL_SOPORTISTA')}">Usuario</span>
                            </p>
                            <div id="infoUsuario">
                                <h3 style="display: inline;" th:text="${usuario.nombre} + ${usuario.apellido != null ? ' ' + usuario.apellido : ''}"></h3>
                                <p style="display: inline;" th:text="'ID#' + ${usuario.codigo}"></p>
                            </div>
                            <p id="infoUsuario">
                                <b>Departamento:</b> 
                                <span th:text="${usuario.departamento != null and !usuario.departamento.isEmpty()} ? ${usuario.departamento} : 'Sin Información...'"></span>
                            </p>
                            <p id="infoUsuario">
                                <b>Último Acceso al Sistema:</b>
                                <span th:if="${ultimaConexion != null}" 
                                      th:text="${#temporals.format(ultimaConexion, 'EEEE, d ''de'' MMMM ''de'' yyyy', new java.util.Locale('es', 'ES'))}">
                                </span>
                                <span th:unless="${ultimaConexion != null}">
                                    Sin información
                                </span>
                            </p>
                        </div>

                        <button class="btn-update" onclick="window.history.back();">Cancelar</button>

                    </div>

                    <div class="profile-details">
                        <div class="detail-row">
                            <div class="detail-column">
                                <label for="nombre">Nombre</label>
                                <input type="text" 
                                       id="nombre"
                                       name="nombre" 
                                       th:value="${usuario.nombre}" 
                                       maxlength="50" 
                                       placeholder="Ingrese su nombre..." 
                                       required>
                            </div>
                            <div class="detail-column">
                                <label for="apellido">Apellidos</label>
                                <input type="text" 
                                       id="apellido"
                                       name="apellido" 
                                       th:value="${usuario.apellido}" 
                                       maxlength="50" 
                                       placeholder="Ingrese sus apellidos..." 
                                       required>
                            </div>
                        </div>

                        <div class="detail-row single-column">
                            <div class="detail-column">
                                <label for="direccion">Dirección</label>
                                <textarea id="direccion"
                                          name="direccion" 
                                          class="form-control" 
                                          th:text="${usuario.direccion}" 
                                          placeholder="Ingrese su dirección completa..."
                                          rows="5"></textarea>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-column">
                                <label for="provincia">Provincia</label>
                                <select id="provincia" name="provincia" class="form-select">
                                    <option value="">Seleccione una provincia...</option>
                                    <option value="Heredia" th:selected="${usuario.provincia == 'Heredia'}">Heredia</option>
                                    <option value="San José" th:selected="${usuario.provincia == 'San José'}">San José</option>
                                    <option value="Alajuela" th:selected="${usuario.provincia == 'Alajuela'}">Alajuela</option>
                                    <option value="Cartago" th:selected="${usuario.provincia == 'Cartago'}">Cartago</option>
                                    <option value="Guanacaste" th:selected="${usuario.provincia == 'Guanacaste'}">Guanacaste</option>
                                    <option value="Puntarenas" th:selected="${usuario.provincia == 'Puntarenas'}">Puntarenas</option>
                                    <option value="Limón" th:selected="${usuario.provincia == 'Limón'}">Limón</option>
                                </select>
                            </div>
                            <div class="detail-column">
                                <label for="departamento">Departamento</label>
                                <select id="departamento" name="departamento" class="form-select" required>
                                    <option value="">Seleccione un departamento...</option>
                                    <option th:each="departamento : ${departamentos}" 
                                            th:value="${departamento.nombre}" 
                                            th:text="${departamento.nombre}"
                                            th:selected="${usuario.departamento == departamento.nombre}"
                                            th:if="${#lists.contains(usuario.roles.![nombre], 'ROL_ADMINISTRADOR') or departamento.visible or usuario.departamento == departamento.nombre}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-column">
                                <label for="numeroTelefono">Número de Teléfono</label>
                                <input type="text" 
                                       id="numeroTelefono"
                                       name="numeroTelefono" 
                                       th:value="${usuario.numeroTelefono}" 
                                       pattern="\d{8}" 
                                       required
                                       maxlength="8"
                                       placeholder="Ingrese su numero de telefono..."
                                       oninput="validarTelefono(this)">
                            </div>

                            <div class="detail-column">
                                <div class="label-with-icon">
                                    <label for="contrasena">Contraseña</label>
                                    <span class="password-info-icon">
                                        <i class="fas fa-info-circle"></i>
                                        <div class="password-popover-container">
                                            <div class="password-popover">
                                                <div class="password-popover-title">Información Relevante</div>
                                                <div class="password-popover-content">
                                                    Por seguridad, su contraseña está protegida mediante encriptación. 
                                                    Si desea modificarla, le enviaremos un enlace de confirmación a su correo electrónico registrado.
                                                </div>
                                            </div>
                                        </div>
                                    </span>
                                </div>

                                <div class="password-field">
                                    <meta name="_csrf" th:content="${_csrf.token}"/>
                                    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
                                    <input type="password" 
                                           id="passwordInput" 
                                           name="contrasena"
                                           th:value="${usuario.contrasena}" 
                                           class="readonly-field" 
                                           placeholder="••••••••••••••••••••••••••••••••••••••••••••••••••••••••" 
                                           readonly>
                                    <button type="button" class="toggle-password" onclick="solicitarCambioContrasena()">
                                        <i class="fa-solid fa-key" id="toggleIcon"></i>
                                        <div class="password-change-popover-container">
                                            <div class="password-change-popover">
                                                <div class="password-change-popover-title">Cambiar Contraseña</div>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-column">
                                <label for="correoElectronico">Correo Electrónico</label>
                                <input id="correoElectronico" 
                                       type="email" 
                                       name="correoElectronico" 
                                       th:value="${usuario.correoElectronico}" 
                                       class="readonly-field" 
                                       placeholder="usuario@ejemplo.com" 
                                       readonly>
                            </div>
                            <div class="detail-column">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn-guardar-cambios">
                                    <i class="fa-solid fa-floppy-disk"></i>
                                    Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </section>

        <section th:fragment="historial-section">
            <meta name="_csrf" th:content="${_csrf.token}"/>
            <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
            <div class="ticket-list-container">
                <div class="ticket-list-header">
                    <div class="header-title">
                        <h2>Historial de Tickets</h2>
                        <div class="ticket-counter">
                            <span class="counter-number" id="ticketCounter">0</span>
                            <span class="counter-label">tickets disponibles</span>
                        </div>
                    </div>
                    <div class="search-filter">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" placeholder="Buscar por título, ID o descripción...">
                        </div>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter="status">
                            <span>Estado</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="priority">
                            <span>Prioridad</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="category">
                            <span>Categoría</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="date">
                            <span>Fecha</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <button class="button clear-filters" id="clearFilters" style="display: none; font-family: 'Poppins', sans-serif;">
                        <i class="fas fa-arrow-rotate-right"></i>
                        Limpiar filtros
                    </button>
                </div>

                <div class="active-filters" id="activeFilters">
                </div>

                <div class="filter-dropdown" id="statusFilter">
                    <div class="dropdown-content">
                        <th:block th:if="${esSoportistaOAdmin}">
                            <label><input type="checkbox" name="status" value="Abierto" checked> Abierto</label>
                            <label><input type="checkbox" name="status" value="Pendiente" checked> Pendiente</label>
                            <label><input type="checkbox" name="status" value="Resuelto" checked> Resuelto</label>
                            <label><input type="checkbox" name="status" value="Cerrado" checked> Cerrado</label>
                            <label><input type="checkbox" name="status" value="Desactivado" checked> Desactivado</label>
                            <label><input type="checkbox" name="status" value="Cancelado" checked> Cancelado</label>
                        </th:block>
                        <th:block th:unless="${esSoportistaOAdmin}">
                            <label><input type="checkbox" name="status" value="Abierto" checked> En Revisión</label>
                            <label><input type="checkbox" name="status" value="Pendiente" checked> En Progreso</label>
                            <label><input type="checkbox" name="status" value="Resuelto" checked> Solucionado</label>
                            <label><input type="checkbox" name="status" value="Cerrado" checked> Cerrado</label>
                            <label><input type="checkbox" name="status" value="Desactivado" checked> Desactivado</label>
                            <label><input type="checkbox" name="status" value="Cancelado" checked> Cancelado</label>
                        </th:block>
                    </div>
                </div>

                <div class="filter-dropdown" id="priorityFilter">
                    <div class="dropdown-content">
                        <label><input type="checkbox" name="priority" value="Alto" checked> Alto</label>
                        <label><input type="checkbox" name="priority" value="Medio" checked> Medio</label>
                        <label><input type="checkbox" name="priority" value="Bajo" checked> Bajo</label>
                        <label><input type="checkbox" name="priority" value="Critico" checked> Critico</label>
                    </div>
                </div>

                <div class="filter-dropdown" id="categoryFilter">
                    <div class="dropdown-content">
                        <th:block th:each="categoria : ${categoriasActivas}">
                            <label>
                                <input type="checkbox" name="category" th:value="${categoria.nombre}" checked>
                                <span th:text="${categoria.nombre}">Categoría</span>
                            </label>
                        </th:block>
                        <th:block th:if="${#lists.isEmpty(categoriasActivas)}">
                            <p>No hay categorías activas disponibles.</p>
                        </th:block>
                    </div>
                </div>

                <div class="filter-dropdown" id="dateFilter">
                    <div class="dropdown-content date-range">
                        <div class="date-input-group">
                            <label>Desde:</label>
                            <input type="text" id="fechaFrom" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="date-input-group">
                            <label>Hasta:</label>
                            <input type="text" id="fechaTo" placeholder="dd/mm/yyyy">
                        </div>
                        <button class="button apply-date">Aplicar</button>
                    </div>
                </div>

                <div class="ticket-list" id="ticketList">
                    <div th:each="ticketData : ${ticketsConEstados}" class="ticket-card" 
                         th:data-id="${ticketData.ticket.idTicket}" 
                         th:data-priority="${ticketData.ticket.prioridad}" 
                         th:data-category="${ticketData.ticket.categoria}" 
                         th:data-status="${ticketData.estadoMostrado}">
                        <div class="ticket-meta">
                            <div class="ticket-header">
                                <span class="ticket-id">
                                    <i class="fas fa-ticket"></i> 
                                    <span th:text="${ticketData.ticket.codigo}">TIC001</span>
                                </span>
                                <div class="ticket-tags">
                                    <span class="status" 
                                          th:classappend="${'status-' + ticketData.estadoMostrado.toLowerCase().replace(' ', '-')}"
                                          th:text="${ticketData.estadoMostrado}">
                                        Estado
                                    </span>
                                    <span class="priority" 
                                          th:classappend="${'priority-' + ticketData.ticket.prioridad.toLowerCase().replace(' ', '-')}">
                                        <i class="fa-solid fa-flag"></i>
                                        <span th:text="${ticketData.ticket.prioridad}">Prioridad</span>
                                    </span>
                                </div>
                            </div>
                            <span class="date">
                                Fecha: <span th:text="${#dates.format(ticketData.ticket.fechaApertura, 'dd-MM-yyyy')}">24-08-2024</span>
                            </span>
                        </div>
                        <div class="ticket-content">
                            <h3 th:text="${ticketData.ticket.titulo}">Título del Ticket</h3>
                            <p th:text="${ticketData.ticket.descripcion != null ? (#strings.length(ticketData.ticket.descripcion) > 100 ? #strings.substring(ticketData.ticket.descripcion,0,100) + '...' : ticketData.ticket.descripcion) : ''}">Descripción del ticket...</p>
                        </div>
                        <div class="ticket-footer">
                            <div class="footer-left">
                                <div class="category-tag">
                                    <i class="fa-solid fa-tag"></i>
                                    <span th:text="${ticketData.ticket.categoria}">Categoría</span>
                                </div>
                                <div th:if="${ticketData.tieneArchivos}" class="archive-tag">
                                    <span class="attachment-icon">
                                        <i class="fas fa-paperclip"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="footer-buttons">
                                <button class="button-32" th:onclick="|window.location.href='@{/usuario/detalles/{id}(id=${ticketData.ticket.idTicket})}'|">Ver Detalles</button>
                                <button class="button-32 cancel-button" th:if="${ticketData.ticket.estado == 'Abierto' and ticketData.ticket.asignadoPara == null}">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <div id="noMatchesMessage" class="no-matches-message" style="display: none;">
                        <div class="no-matches-content">
                            <div class="no-matches-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="no-matches-info">
                                <h3>No se encontraron coincidencias</h3>
                                <p>No hay tickets que coincidan con los filtros o la búsqueda aplicada. Intenta ajustar los criterios de búsqueda o limpia los filtros.</p>
                            </div>
                            <button class="btn clean-filter-btn" id="clearFiltersFromNoMatches">
                                <i class="fas fa-arrow-rotate-right"></i>
                                <span>Limpiar filtros</span>
                            </button>
                        </div>
                    </div>

                    <div th:unless="${not ticketsConEstados.empty}" class="no-tickets-message">
                        <div class="no-tickets-content">
                            <div class="no-tickets-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="no-tickets-info">
                                <h3>No tienes tickets en tu historial</h3>
                                <p>Tu espacio de trabajo está vacío. Cuando crees un ticket de soporte, aparecerá en esta sección para su respectivo seguimiento.</p>
                            </div>
                            <div class="no-tickets-actions">
                                <a th:href="@{/tickets/nuevo}" class="btn create-ticket-btn">
                                    <i class="fas fa-plus-circle"></i>
                                    <span>Crear nuevo ticket</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="cancelTicketModal" class="file-modal" style="display: none;">
                <div class="modal-container" style="text-align: center; padding: 30px;">
                    <h3>
                        ¿Estás seguro de cancelar el ticket: 
                        <span id="ticketToCancelCode" style="color: #4f46e5; font-weight: bold;"></span>?
                    </h3>
                    <p>El ticket <strong id="ticketToCancelTitle"></strong> será marcado como cancelado. Esta acción no se puede deshacer.</p>
                    <div style="margin-top: 20px;">
                        <button id="confirmCancel" class="btn btn-primary">Confirmar</button>
                        <button id="closeCancelModal" class="btn btn-secondary">Cerrar</button>
                    </div>
                </div>
            </div>
        </section>

        <section th:fragment="ticket-detalle-section">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <div class="back-button-container" style="margin-bottom: 15px;">
        <button class="btn btn-outline-secondary back-button" id="ticketDetailsBackButton">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        <h2 id="Title" style="margin: initial;">Detalles del Ticket</h2>
    </div>

    <div class="main-container">
        <div class="ticket-details">
            <div class="ticket-header">
                <div class="ticket-id"><i class="fas fa-ticket"></i> <span th:text="${ticket.codigo}">#TIC00000000</span></div>
                <span id="status-badge" th:class="${'status-' + 
                      (ticket.estado == 'Abierto' ? 'en-revision' : 
                      ticket.estado == 'Pendiente' ? 'en-progreso' : 
                      ticket.estado == 'Resuelto' ? 'solucionado' : 
                      ticket.estado == 'Desactivado' ? 'desactivado' : 
                      ticket.estado == 'Cancelado' ? 'cancelado' : 
                      'cerrado')}">
                    <i th:class="${ticket.estado == 'Abierto' ? 'far fa-clock' : 
                       ticket.estado == 'Pendiente' ? 'fa-solid fa-arrows-rotate' : 
                       ticket.estado == 'Resuelto' ? 'fas fa-check-circle' : 
                       ticket.estado == 'Desactivado' ? 'fas fa-ban' : 
                       ticket.estado == 'Cancelado' ? 'fas fa-times-circle' : 
                       'fas fa-lock'}"></i>
                    <th:block th:with="esUsuario=${usuario?.roles != null and #lists.contains(usuario.roles.![nombre], 'ROL_USUARIO') 
                              and not #lists.contains(usuario.roles.![nombre], 'ROL_ADMINISTRADOR') 
                              and not #lists.contains(usuario.roles.![nombre], 'ROL_SOPORTISTA')}">
                        <span th:if="${esUsuario}"
                              th:text="${ticket.estado == 'Abierto' ? 'En Revisión' : 
                              ticket.estado == 'Pendiente' ? 'En Progreso' : 
                              ticket.estado == 'Resuelto' ? 'Solucionado' : 
                              ticket.estado == 'Desactivado' ? 'Desactivado' : 
                              ticket.estado == 'Cancelado' ? 'Cancelado' : 
                              'Cerrado'}">Estado</span>
                        <span th:unless="${esUsuario}" th:text="${ticket.estado}">Estado</span>
                    </th:block>
                </span>
            </div>
            <div class="ticket-title" th:text="${ticket.titulo}">Titulo...</div>
            <p class="ticket-description" th:text="${ticket.descripcion}">
                Descripcion...
            </p>
            <div class="info-grid">
                <div class="info-item">
                    <label>Fecha de Apertura:</label>
                    <div th:text="${#dates.format(ticket.fechaApertura, 'dd MMMM yyyy - HH:mm:ss')}">24 de Agosto del 2024 - 13:45:12</div>
                </div>
                <div class="info-item">
                    <label>Prioridad:</label>
                    <div th:text="${ticket.prioridad}">Sin Asignar</div>
                </div>
                <div class="info-item">
                    <label>Encargado:</label>
                    <div th:if="${ticket.asignadoPara != null}" 
                         th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">
                        Sin Asignar
                    </div>
                    <div th:unless="${ticket.asignadoPara != null}">Sin Asignar</div>
                </div>
                <div class="info-item">
                    <label>Última Actualización:</label>
                    <div th:text="${#dates.format(ticket.fechaActualizacion, 'dd MMMM yyyy - HH:mm:ss')}">24 de Agosto del 2024 - 13:45:12</div>
                </div>
                <div class="info-item">
                    <label>Categoría:</label>
                    <div th:text="${ticket.categoria}">Sistemas</div>
                </div>
            </div>

            <div class="attachments" th:if="${not #lists.isEmpty(imagenes)}">
                <div class="attachments-header">
                    <label>ARCHIVOS ADJUNTOS</label>
                </div>

                <div class="manager-info">
                    <h2>Información del Encargado</h2>

                    <div th:if="${ticket.asignadoPara != null}" class="manager-content">
                        <div class="agent-profile">
                            <div class="agent-photo">
                                <img th:if="${ticket.asignadoPara.imagen != null}" 
                                     th:src="@{/usuario/imagen/{id}(id=${ticket.asignadoPara.idUsuario})}" 
                                     alt="Foto de perfil">
                                <i th:unless="${ticket.asignadoPara.imagen != null}" class="fas fa-user-circle"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-role">Equipo de Soporte</div>
                                <div class="agent-name" th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">Nombre del Soportista</div>
                            </div>
                        </div>

                        <div class="info-field">
                            <label>Codigo de Identificación</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.codigo}" placeholder="ID">
                        </div>

                        <div class="info-field">
                            <label>Departamento</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.departamento}" placeholder="Departamento">
                        </div>

                        <div class="info-field">
                            <label>Numero de Teléfono</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.numeroTelefono}" placeholder="Telefono no disponible">
                        </div>

                        <div class="info-field">
                            <label>Correo Electrónico</label>
                            <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.correoElectronico}" placeholder="Sin correo registrado">
                        </div>

                        <div class="tickets-counter">
                            <div class="counter-label">Tickets Atendidos por Soportista</div>
                            <div class="counter-value">
                                <i class="fas fa-ticket-alt"></i>
                                <span th:text="${ticketsAtendidos != null ? ticketsAtendidos : '0'}">0</span>
                            </div>
                        </div>
                    </div>

                    <div th:unless="${ticket.asignadoPara != null}" class="manager-content">
                        <div class="manager-icon">
                            <i th:class="${ticket.estado == 'Cancelado' ? 'fas fa-times-circle' : 
                               ticket.estado == 'Resuelto' ? 'fas fa-check-circle' : 
                               ticket.estado == 'Desactivado' ? 'fas fa-ban' : 
                               ticket.estado == 'Cerrado' ? 'fas fa-lock' : 
                               'fas fa-headset'}"></i>
                        </div>
                        <div class="manager-status">
                            <strong th:text="${ticket.estado == 'Abierto' ? 'Su ticket está en revisión.' : 
                                    ticket.estado == 'Pendiente' ? 'Su ticket está en progreso.' : 
                                    ticket.estado == 'Resuelto' ? 'Su ticket ha sido solucionado.' : 
                                    ticket.estado == 'Cancelado' ? 'Su ticket ha sido cancelado.' :
                                    ticket.estado == 'Desactivado' ? 'Su ticket ha sido desactivado.' :
                                    ticket.estado == 'Cerrado' ? 'Su ticket ha sido cerrado.' :
                                    'Su ticket ha sido cerrado.'}">Estado del ticket</strong>
                            <p th:text="${ticket.estado == 'Cancelado' ? 'Su solicitud ha sido cancelada. Si necesita asistencia o tiene alguna consulta, puede crear un nuevo ticket.' : 
                               ticket.estado == 'Resuelto' ? 'Su solicitud ha sido resuelto exitosamente. Si persiste algún inconveniente, puede crear un nuevo ticket.' :
                               ticket.estado == 'Desactivado' ? 'Su ticket ha sido desactivado. Para obtener soporte, por favor cree un nuevo ticket.' :
                               ticket.estado == 'Cerrado' ? 'Su ticket ha sido cerrado. Si necesita asistencia adicional, puede crear un nuevo ticket.' :
                               'Pronto un soportista se pondrá en contacto con usted.'}">Mensaje del ticket</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cancel-section" 
                 th:if="${ticket.estado == 'Abierto'
                 and ticket.asignadoPara == null
                 and usuario?.roles != null
                 and #lists.contains(usuario.roles.![nombre], 'ROL_USUARIO')}">
                <div class="cancel-button-container">
                    <button class="btn cancel-button">
                        <i class="fa-solid fa-trash-can"></i> Cancelar Solicitud
                    </button>
                </div>
            </div>
        </div>

        <div class="manager-info">
            <h2>Información del Encargado</h2>

            <div th:if="${ticket.asignadoPara != null}" class="manager-content">
                <div class="agent-profile">
                    <div class="agent-photo">
                        <img th:if="${ticket.asignadoPara.imagen != null}" 
                             th:src="@{/usuario/imagen/{id}(id=${ticket.asignadoPara.idUsuario})}" 
                             alt="Foto de perfil">
                        <i th:unless="${ticket.asignadoPara.imagen != null}" class="fas fa-user-circle"></i>
                    </div>
                    <div class="agent-info">
                        <div class="agent-role">Equipo de Soporte</div>
                        <div class="agent-name" th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">Nombre del Soportista</div>
                    </div>
                </div>

                <div class="info-field">
                    <label>Codigo de Identificación</label>
                    <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.codigo}" placeholder="ID">
                </div>

                <div class="info-field">
                    <label>Departamento</label>
                    <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.departamento}" placeholder="Departamento">
                </div>

                <div class="info-field">
                    <label>Numero de Teléfono</label>
                    <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.numeroTelefono}" placeholder="Telefono no disponible">
                </div>

                <div class="info-field">
                    <label>Correo Electrónico</label>
                    <input class="form-control" type="text" readonly th:value="${ticket.asignadoPara.correoElectronico}" placeholder="Sin correo registrado">
                </div>

                <div class="tickets-counter">
                    <div class="counter-label">Total de Tickets Atendidos</div>
                    <div class="counter-value">
                        <i class="fas fa-ticket-alt"></i>
                        <span th:text="${ticketsAtendidos != null ? ticketsAtendidos : '0'}">0</span>
                    </div>
                </div>
            </div>

            <div th:unless="${ticket.asignadoPara != null}" class="manager-content">
                <div class="manager-icon">
                    <i th:class="${ticket.estado == 'Cancelado' ? 'fas fa-times-circle' : 
                       ticket.estado == 'Resuelto' ? 'fas fa-check-circle' : 
                       ticket.estado == 'Desactivado' ? 'fas fa-ban' : 
                       ticket.estado == 'Cerrado' ? 'fas fa-lock' : 
                       'fas fa-headset'}"></i>
                </div>
                <div class="manager-status">
                    <strong th:text="${ticket.estado == 'Abierto' ? 'Su ticket está en revisión.' : 
                            ticket.estado == 'Pendiente' ? 'Su ticket está en progreso.' : 
                            ticket.estado == 'Resuelto' ? 'Su ticket ha sido solucionado.' : 
                            ticket.estado == 'Cancelado' ? 'Su ticket ha sido cancelado.' :
                            ticket.estado == 'Desactivado' ? 'Su ticket ha sido desactivado.' :
                            ticket.estado == 'Cerrado' ? 'Su ticket ha sido cerrado.' :
                            'Su ticket ha sido cerrado.'}">Estado del ticket</strong>
                    <p th:text="${ticket.estado == 'Cancelado' ? 'Su solicitud ha sido cancelada. Si necesita asistencia o tiene alguna consulta, puede crear un nuevo ticket.' : 
                       ticket.estado == 'Resuelto' ? 'Su solicitud ha sido resuelto exitosamente. Si persiste algún inconveniente, puede crear un nuevo ticket.' :
                       ticket.estado == 'Desactivado' ? 'Su ticket ha sido desactivado. Para obtener soporte, por favor cree un nuevo ticket.' :
                       ticket.estado == 'Cerrado' ? 'Su ticket ha sido cerrado. Si necesita asistencia adicional, puede crear un nuevo ticket.' :
                       'Pronto un soportista se pondrá en contacto con usted.'}">Mensaje del ticket</p>
                </div>
            </div>
        </div>
    </div>

    <div id="cancelTicketModal" class="file-modal" style="display: none;">
        <div class="modal-container" style="text-align: center; padding: 30px;">
            <h3>¿Estás seguro de cancelar este ticket?</h3>
            <p>El ticket será marcado como cancelado. Esta accion no se puede deshacer</p>
            <div style="margin-top: 20px;">
                <button id="confirmCancel" class="btn btn-primary">Confirmar</button>
                <button id="closeCancelModal" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="fileModal" class="file-modal">
        <span class="close-modal"><i class="fa-solid fa-xmark"></i></span>
        <div class="modal-content-container">
            <img id="modalFileImage" class="modal-content" style="display: none;">
            <iframe id="modalFilePdf" class="modal-content" style="width: 1300px;; height: 90vh; display: block; border: none;"></iframe>
            <div id="modalFileName" class="file-name-modal"></div>
        </div>
    </div>
</section>


        <section th:fragment="usuarios-listado">

            <div th:if="${mensaje}" class="alert alert-success" role="alert">
                <span th:text="${mensaje}"></span>
            </div>

            <div class="container-fluid">
                <div class="search-section">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Buscar por nombre, código, correo, teléfono..." 
                               id="searchInput" th:value="${searchQuery}">
                    </div>
                    <div class="action-buttons">
                        <select id="statusFilter" class="status-filter">
                            <option value="">Todos los estados</option>
                            <option value="activo" th:selected="${estadoFiltro == 'activo'}">Activos</option>
                            <option value="inactivo" th:selected="${estadoFiltro == 'inactivo'}">Inactivos</option>
                        </select>

                        <select id="roleFilter" class="status-filter">
                            <option value="">Todos los roles</option>
                            <option value="ROL_ADMINISTRADOR" th:selected="${rolFiltro == 'ROL_ADMINISTRADOR'}">Administradores</option>
                            <option value="ROL_SOPORTISTA" th:selected="${rolFiltro == 'ROL_SOPORTISTA'}">Soportistas</option>
                            <option value="ROL_USUARIO" th:selected="${rolFiltro == 'ROL_USUARIO'}">Usuarios</option>
                        </select>

                        <button id="btnCreateUser" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Agregar Nuevo Usuario
                        </button>
                    </div>
                </div>

                <div class="table-header">
                    <div class="pagination-left">
                        <span>Mostrar</span>
                        <select id="recordsPerPage" class="records-select">
                            <option value="15" th:selected="${pageSize == 15}">15</option>
                            <option value="30" th:selected="${pageSize == 30}">30</option>
                            <option value="50" th:selected="${pageSize == 50}">50</option>
                            <option value="100" th:selected="${pageSize == 100}">100</option>
                        </select>
                        <span>registros por página</span>
                    </div>
                    <div class="pagination-center">
                        <span id="pageInfo" th:text="'Mostrando ' + ${start} + ' a ' + ${end} + ' de ' + ${totalItems} + ' registros'">
                            Mostrando 1 a 10 de 50 registros
                        </span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=0,size=${pageSize})} + '\''"
                                th:disabled="${currentPage == 0}">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${currentPage-1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage == 0}">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <div class="page-numbers" id="pageNumbers">
                            <button th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                                    th:class="'page-number ' + ${pageNum == currentPage ? 'active' : ''}"
                                    th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${pageNum},size=${pageSize})} + '\''"
                                    th:text="${pageNum + 1}">1</button>
                        </div>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${currentPage+1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage >= totalPages - 1}">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${totalPages-1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage >= totalPages - 1}">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="tickets-table table-resizable">
                        <thead>
                            <tr>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">ID</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Imagen</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Código</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Nombre Completo</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Correo Electrónico</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Departamento</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Teléfono</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Roles</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Estado</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Última Conexión</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Acciones</div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario : ${usuarios}">
                                <td th:text="${usuario.idUsuario}"></td>
                                <td style="padding: 2px;">
                                    <img th:if="${usuario.imagen != null}" 
                                         th:src="@{/usuario/imagen/{id}(id=${usuario.idUsuario})}" 
                                         class="user-img" style="width: 35px; height: 35px; display: block; margin: 0 auto;">
                                    <span th:unless="${usuario.imagen != null}" class="badge badge-desactivado" style="display: block; text-align: center;">Sin imagen</span>
                                </td>
                                <td th:text="${usuario.codigo} ?: 'Sin código'"></td>
                                <td th:text="${usuario.nombre + (usuario.apellido != null and !usuario.apellido.isEmpty() ? ' ' + usuario.apellido : '')}"></td>
                                <td th:text="${usuario.correoElectronico} ?: 'Sin correo...'"></td>
                                <td th:text="${usuario.departamento} ?: 'Sin dpto...'"></td>
                                <td th:text="${usuario.numeroTelefono != null} ? ${usuario.numeroTelefono} : 'Sin Numero...'"></td>
                                <td>
                                    <th:block th:if="${#lists.isEmpty(usuario.roles)}">
                                        <span class="badge badge-desactivado">Sin rol...</span>
                                    </th:block>
                                    <span th:each="rol : ${usuario.roles}" 
                                          th:text="${rol.nombre}" 
                                          class="badge badge-abierto"></span>
                                </td>
                                <td>
                                    <span th:text="${usuario.activo ? 'Activo' : 'Inactivo'}" 
                                          th:class="${usuario.activo ? 'badge badge-resuelto' : 'badge badge-cancelado'}"></span>
                                </td>
                                <td th:text="${usuario.ultimaConexion != null} ? ${#dates.format(usuario.ultimaConexion, 'dd/MM/yyyy HH:mm:ss')} : 'Sin conexión'"></td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        <button th:if="${(usuarioLogueado.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0) || 
                                                (usuarioLogueado.roles.?[nombre == 'ROL_SOPORTISTA'].size() > 0 && 
                                                usuario.roles.?[nombre == 'ROL_USUARIO'].size() > 0)}" 
                                                class="btn" style="padding: 4px 8px;" 
                                                th:data-id="${usuario.idUsuario}" 
                                                data-action="edit">
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        <a th:if="${(usuarioLogueado.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0) && 
                                           (usuario.idUsuario != usuarioLogueado.idUsuario)}" 
                                           th:href="@{'/usuario/eliminar/' + ${usuario.idUsuario}}" 
                                           class="btn" style="padding: 4px 8px;">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(usuarios)}">
                                <td colspan="11" style="text-align: center;">No se encontraron usuarios en el sistema</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="createModal" class="modal-overlay">
                <div class="modal">
                    <div class="modal-header">
                        <h5 class="modal-title">Agregar Nuevo Usuario</h5>
                    </div>
                    <div class="modal-body">
                        <form id="formCreateUser" th:action="@{/usuario/crear}" method="post" enctype="multipart/form-data">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="nombre">Nombre: <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="apellido">Apellido:</label>
                                        <input type="text" class="form-control" id="apellido" name="apellido" placeholder="Opcional">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="correoElectronico">Correo Electrónico: <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="correoElectronico" name="correoElectronico" required>
                            </div>
                            <div class="form-group">
                                <label for="departamento">Departamento: <span class="text-danger">*</span></label>
                                <select class="form-control" id="departamento" name="departamento" required>
                                    <option value="">Seleccionar departamento</option>
                                    <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep}"></option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="contrasena">Contraseña: <span class="text-danger">*</span></label>
                                <input class="form-control" id="contrasena" name="contrasena" required minlength="3">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="numeroTelefono">Teléfono:</label>
                                        <input type="text" class="form-control" id="numeroTelefono" name="numeroTelefono" placeholder="Opcional">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="rol">Rol:</label>
                                        <select class="form-control" id="rol" name="rol">
                                            <option value="ROL_USUARIO" selected>Usuario</option>
                                            <option value="ROL_ADMINISTRADOR">Administrador</option>
                                            <option value="ROL_SOPORTISTA">Soportista</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="imagenFile">Imagen de Perfil:</label>
                                <input type="file" class="form-control" id="imagenFile" name="imagenFile" accept="image/*">
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="activo" name="activo" value="true" checked>
                                <label class="form-check-label" for="activo">Usuario Activo</label>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline" data-modal-action="close" data-modal-id="createModal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="editModal" class="modal-overlay">
                <div class="modal">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Usuario</h5>
                    </div>
                    <div class="modal-body">
                        <form id="formEditUser" th:action="@{/usuario/actualizar}" method="post" enctype="multipart/form-data">
                            <input type="hidden" id="editUserId" name="idUsuario">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editNombre">Nombre: <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="editNombre" name="nombre" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editApellido">Apellido:</label>
                                        <input type="text" class="form-control" id="editApellido" name="apellido">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editCorreoElectronico">Correo Electrónico: <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="editCorreoElectronico" name="correoElectronico" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editDepartamento">Departamento:</label>
                                        <select class="form-control" id="editDepartamento" name="departamento">
                                            <option value="">Seleccionar departamento</option>
                                            <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editNumeroTelefono">Teléfono:</label>
                                        <input type="text" class="form-control" id="editNumeroTelefono" name="numeroTelefono">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editContrasena">Contraseña (dejar en blanco para mantener la actual):</label>
                                <input class="form-control" id="editContrasena" name="contrasena">
                            </div>
                            <div class="form-group">
                                <label for="editImagenFile">Imagen de Perfil:</label>
                                <input type="file" class="form-control" id="editImagenFile" name="imagenFile" accept="image/*">
                                <div id="currentImageContainer" class="mt-2" style="display: none;">
                                    <p>Imagen actual:</p>
                                    <img id="currentImage" src="" alt="Imagen actual" style="max-width: 100px; max-height: 100px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editRol">Rol:</label>
                                <select class="form-control" id="editRol" name="rol">
                                    <option value="ROL_ADMINISTRADOR">Administrador</option>
                                    <option value="ROL_SOPORTISTA">Soportista</option>
                                    <option value="ROL_USUARIO">Usuario</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="editActivo" name="activo" value="true">
                                <label class="form-check-label" for="editActivo">Usuario Activo</label>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline" data-modal-action="close" data-modal-id="editModal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="deleteModal" class="modal-overlay">
                <div class="modal modal--delete">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar Eliminación</h5>
                    </div>
                    <div class="modal-body">
                        <p>¿Está seguro que desea eliminar al usuario <span id="deleteUserName" class="font-weight-bold"></span>?</p>
                        <p class="text-danger">Esta acción no se puede deshacer.</p>
                        <form id="formDeleteUser" method="post">
                            <input type="hidden" id="deleteUserId" name="id">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline" data-modal-action="close" data-modal-id="editModal">Cancelar</button>
                                <button type="submit" class="btn btn-danger">Eliminar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="globalLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
                <div style="color: white; font-size: 24px;">
                    <i class="fas fa-spinner fa-spin"></i> Procesando...
                </div>
            </div>

            <div id="toast-success" class="toast-modal toast-success">
                <div class="toast-content">
                    <p class="toast-message">
                        <i class="toast-icon fas fa-check-circle"></i>
                        <span>Operación exitosa</span>
                    </p>
                    <span class="toast-close">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>

            <div id="toast-error" class="toast-modal toast-error">
                <div class="toast-content">
                    <p class="toast-message">
                        <i class="toast-icon fas fa-exclamation-circle"></i>
                        <span>Ocurrió un error</span>
                    </p>
                    <span class="toast-close">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>
        </section>

        <section th:fragment="configuracion-section">
            <div class="container">
                <h2 class="mb-4" id="Title">Ajustes Generales</h2>
                <div class="settings-list">
                    <div class="settings-item">
                        <a href="/usuario/editar" class="settings-link">
                            <div class="settings-content">
                                <div class="settings-text">
                                    <h3>Actualizar Información de Perfil</h3>
                                    <p class="text-muted">Actualice su información personal</p>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>

                    <div class="settings-item" sec:authorize="hasAnyAuthority('ROL_ADMINISTRADOR', 'ROL_SOPORTISTA')">
                        <a href="/categoria/listado" class="settings-link">
                            <div class="settings-content">
                                <div class="settings-text">
                                    <h3>Administrar de Categorias</h3>
                                    <p class="text-muted">Gestione y mantenga actualizadas las categorías disponibles en el sistema.</p>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>

                    <div class="settings-item" sec:authorize="hasAnyAuthority('ROL_ADMINISTRADOR', 'ROL_SOPORTISTA')">
                        <a href="/usuario/listado" class="settings-link">
                            <div class="settings-content">
                                <div class="settings-text">
                                    <h3>Administrar Usuarios</h3>
                                    <p class="text-muted">Gestione los perfiles de usuario y sus permisos en el sistema.</p>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>

                    <div class="settings-item" sec:authorize="hasAuthority('ROL_ADMINISTRADOR')">
                        <a href="/departamento/listado" class="settings-link">
                            <div class="settings-content">
                                <div class="settings-text">
                                    <h3>Administrar Departamentos</h3>
                                    <p class="text-muted">Gestione los departamentos registrados en el sistema.</p>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>

                    <div class="settings-item-logout">
                        <a href="#" class="settings-link text-danger">
                            <div class="settings-content">
                                <div class="settings-text" id="opcionCerrarSesion">
                                    <h3>Cerrar Sesion</h3>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </body>
</html>