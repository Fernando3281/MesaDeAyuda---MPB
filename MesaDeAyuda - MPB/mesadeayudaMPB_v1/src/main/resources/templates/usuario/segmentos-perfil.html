<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/plantilla :: head}">
        <title>Mesa de Ayuda</title>
    </head>

    <body>
        <section th:fragment="historial">
            <div class="ticket-list-container">
                <div class="ticket-list-header">
                    <div class="header-left">
                        <h2>Historial de Tickets</h2>
                        <div class="ticket-counter">
                            <span class="counter-number" id="ticketCounter">0</span>
                            <span class="counter-label">tickets disponibles</span>
                        </div>
                    </div>
                    <div class="search-filter">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" placeholder="Buscar por título, ID o descripción...">
                        </div>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter="status">
                            <span>Estado</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="priority">
                            <span>Prioridad</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="category">
                            <span>Categoría</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="filter-chip" data-filter="date">
                            <span>Fecha</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <button class="button clear-filters" id="clearFilters">
                        Limpiar filtros
                    </button>
                </div>

                <div class="active-filters" id="activeFilters">
                    <!-- Filtros Activos -->
                </div>

                <!-- Filter Dropdowns -->
                <div class="filter-dropdown" id="statusFilter">
                    <div class="dropdown-content">
                        <label><input type="checkbox" name="status" value="abierto" checked> Abierto</label>
                        <label><input type="checkbox" name="status" value="en-proceso" checked> En Proceso</label>
                        <label><input type="checkbox" name="status" value="cerrado" checked> Cerrado</label>
                    </div>
                </div>

                <div class="filter-dropdown" id="priorityFilter">
                    <div class="dropdown-content">
                        <label><input type="checkbox" name="priority" value="alta" checked> Alta</label>
                        <label><input type="checkbox" name="priority" value="media" checked> Media</label>
                        <label><input type="checkbox" name="priority" value="baja" checked> Baja</label>
                    </div>
                </div>

                <div class="filter-dropdown" id="categoryFilter">
                    <div class="dropdown-content">
                        <label><input type="checkbox" name="category" value="hardware" checked> Hardware</label>
                        <label><input type="checkbox" name="category" value="software" checked> Software</label>
                        <label><input type="checkbox" name="category" value="redes" checked> Redes</label>
                        <label><input type="checkbox" name="category" value="sistemas" checked> Sistemas</label>
                    </div>
                </div>

                <div class="filter-dropdown" id="dateFilter">
                    <div class="dropdown-content date-range">
                        <div class="date-input-group">
                            <label>Desde:</label>
                            <input type="date" id="dateFrom">
                        </div>
                        <div class="date-input-group">
                            <label>Hasta:</label>
                            <input type="date" id="dateTo">
                        </div>
                        <button class="button apply-date">Aplicar</button>
                    </div>
                </div>

                <div class="ticket-list" id="ticketList">
                    <!-- Mostrar tickets si existen -->
                    <div th:each="ticket : ${tickets}" class="ticket-card" 
                         th:data-id="${ticket.codigo}" 
                         th:data-priority="${ticket.prioridad}" 
                         th:data-category="${ticket.categoria}" 
                         th:data-status="${ticket.estado}">
                        <div class="ticket-meta">
                            <div class="ticket-header">
                                <span class="ticket-id">
                                    <i class="fas fa-ticket"></i> 
                                    <span th:text="${ticket.codigo}">TIC001</span>
                                </span>
                                <div class="ticket-tags">
                                    <span class="status" 
                                          th:classappend="${'status-' + ticket.estado.toLowerCase().replace(' ', '-')}" 
                                          th:text="${ticket.estado == 'Abierto' ? 'En Revisión' 
                                          : (ticket.estado == 'Pendiente' ? 'En Progreso' 
                                          : (ticket.estado == 'Resuelto' ? 'Solucionado' 
                                          : ticket.estado))}">
                                        Estado
                                    </span>
                                    <span class="priority" th:classappend="${'priority-' + ticket.prioridad.toLowerCase().replace(' ', '-')}">
                                        <i class="fa-solid fa-flag"></i>
                                        <span th:text="${ticket.prioridad}">Prioridad</span>
                                    </span>
                                </div>
                            </div>
                            <span class="date" th:text="${#dates.format(ticket.fechaApertura, 'dd-MM-yyyy')}">24-08-2024</span>
                        </div>
                        <div class="ticket-content">
                            <h3 th:text="${ticket.titulo}">Título del Ticket</h3>
                            <p th:text="${ticket.descripcion != null ? (#strings.length(ticket.descripcion) > 100 ? #strings.substring(ticket.descripcion,0,100) + '...' : ticket.descripcion) : ''}">Descripción del ticket...</p>
                        </div>
                        <div class="ticket-footer">
                            <div class="category-tag">
                                <i class="fas fa-desktop"></i>
                                <span th:text="${ticket.categoria}">Categoría</span>
                            </div>
                            <div class="footer-buttons">
                                <button class="button-32" th:onclick="|window.location.href='@{/usuario/detalles/{id}(id=${ticket.idTicket})}'|">Ver Detalles</button>
                                <button class="button-32 cancel-button">Cancelar</button>
                            </div>
                        </div>
                    </div>
                    <!-- Componente mejorado para mostrar cuando no hay tickets -->
                    <div th:unless="${not tickets.empty}" class="no-tickets-message">
                        <div class="no-tickets-content">
                            <div class="no-tickets-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="no-tickets-info">
                                <h3>No tienes tickets en tu historial</h3>
                                <p>Tu espacio de trabajo está vacío. Cuando crees un ticket de soporte, aparecerá en esta sección para su respectivo seguimiento.</p>
                            </div>
                            <div class="no-tickets-actions">
                                <a th:href="@{/tickets/nuevo}" class="create-ticket-btn">
                                    <i class="fas fa-plus-circle"></i>
                                    <span>Crear nuevo ticket</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section th:fragment="ticket-detalle">
            <div class="back-button-container" style="margin-bottom: 15px;">
                <a href="javascript:void(0);" onclick="window.history.back();" class="btn btn-outline-secondary back-button">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <h2 id="Title" style="margin: initial;">Detalles del Ticket</h2>
            </div>

            <div class="main-container">
                <div class="ticket-details">
                    <div class="ticket-header">
                        <div class="ticket-id"><i class="fas fa-ticket"></i> <span th:text="${ticket.codigo}">#TIC00000000</span></div>
                        <span id="status-badge" th:class="${'status-' + 
                              (ticket.estado == 'Abierto' ? 'en-revision' : 
                              ticket.estado == 'Pendiente' ? 'en-progreso' : 
                              ticket.estado == 'Resuelto' ? 'solucionado' : 
                              'cerrado')}">
                            <i th:class="${ticket.estado == 'Abierto' ? 'far fa-clock' : 
                               ticket.estado == 'Pendiente' ? 'fa-solid fa-arrows-rotate' : 
                               ticket.estado == 'Resuelto' ? 'fas fa-check-circle' : 
                               'fas fa-lock'}"></i>
                            <span th:text="${ticket.estado == 'Abierto' ? 'En Revisión' : 
                                  ticket.estado == 'Pendiente' ? 'En Progreso' : 
                                  ticket.estado == 'Resuelto' ? 'Solucionado' : 
                                  'Cerrado'}">Estado</span>
                        </span>
                    </div>
                    <div class="ticket-title" th:text="${ticket.titulo}">Titulo...</div>
                    <p class="ticket-description" th:text="${ticket.descripcion}">
                        Descripcion...
                    </p>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Fecha de Apertura:</label>
                            <div th:text="${#dates.format(ticket.fechaApertura, 'dd MMMM yyyy - HH:mm:ss')}">24 de Agosto del 2024 - 13:45:12</div>
                        </div>
                        <div class="info-item">
                            <label>Prioridad:</label>
                            <div th:text="${ticket.prioridad}">Sin Asignar</div>
                        </div>
                        <div class="info-item">
                            <label>Encargado:</label>
                            <div th:if="${ticket.asignadoPara != null}" 
                                 th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">
                                Sin Asignar
                            </div>
                            <div th:unless="${ticket.asignadoPara != null}">Sin Asignar</div>
                        </div>
                        <div class="info-item">
                            <label>Última Actualización:</label>
                            <div th:text="${#dates.format(ticket.fechaActualizacion, 'dd MMMM yyyy - HH:mm:ss')}">24 de Agosto del 2024 - 13:45:12</div>
                        </div>
                        <div class="info-item">
                            <label>Categoría:</label>
                            <div th:text="${ticket.categoria}">Sistemas</div>
                        </div>
                    </div>

                    <!-- Sección de adjuntos -->
                    <div class="attachments" th:if="${not #lists.isEmpty(imagenes)}">
                        <div class="attachments-header">
                            <label>ARCHIVOS ADJUNTOS</label>
                        </div>
                        <div class="files-grid">
                            <div th:each="imagen : ${imagenes}" class="file-item" 
                                 th:data-src="@{/imagenes/ver/{id}(id=${imagen.idImagen})}">
                                <i class="far fa-file-image file-icon"></i>
                                <span class="file-name" th:text="${imagen.nombreArchivo}">Imagen1.jpg</span>
                            </div>
                        </div>
                    </div>

                    <!-- Nueva sección de botón de cancelar -->
                    <div class="cancel-section" 
                         th:if="${ticket.estado == 'Abierto'
                         and ticket.asignadoPara == null}">
                        <div class="cancel-button-container">
                            <button class="cancel-button">
                                <i class="fa-solid fa-trash-can"></i> Cancelar Solicitud
                            </button>
                        </div>
                    </div>
                </div>


                <div class="manager-info">
                    <h2>Información del Encargado</h2>

                    <!-- Mostrar información solo si hay un soportista asignado -->
                    <div th:if="${ticket.asignadoPara != null}" class="manager-content">
                        <!-- Foto y nombre del soportista -->
                        <div class="agent-profile">
                            <div class="agent-photo">
                                <img th:if="${ticket.asignadoPara.imagen != null}" 
                                     th:src="@{/usuario/imagen/{id}(id=${ticket.asignadoPara.idUsuario})}" 
                                     alt="Foto de perfil">
                                    <i th:unless="${ticket.asignadoPara.imagen != null}" class="fas fa-user-circle"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-role">Equipo de Soporte</div>
                                <div class="agent-name" th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">Nombre del Soportista</div>
                            </div>
                        </div>

                        <!-- Campos de información -->
                        <div class="info-field">
                            <label>Identificación</label>
                            <input type="text" readonly th:value="${ticket.asignadoPara.codigo}" placeholder="ID">
                        </div>

                        <div class="info-field">
                            <label>Departamento</label>
                            <input type="text" readonly th:value="${ticket.asignadoPara.departamento}" placeholder="Departamento">
                        </div>

                        <div class="info-field">
                            <label>Numero de Teléfono</label>
                            <input type="text" readonly th:value="${ticket.asignadoPara.numeroTelefono}" placeholder="Sin teléfono registrado">
                        </div>

                        <div class="info-field">
                            <label>Correo Electrónico</label>
                            <input type="text" readonly th:value="${ticket.asignadoPara.correoElectronico}" placeholder="Sin correo registrado">
                        </div>

                        <!-- Contador de tickets -->
                        <div class="tickets-counter">
                            <div class="counter-label">Total de Tickets Atendidos</div>
                            <div class="counter-value">
                                <i class="fas fa-ticket-alt"></i>
                                <!-- Aquí necesitarías agregar un método que cuente tickets atendidos por este soportista para el usuario actual -->
                                <span th:text="${ticketsAtendidos != null ? ticketsAtendidos : '0'}">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mostrar mensaje cuando no hay soportista asignado -->
                    <div th:unless="${ticket.asignadoPara != null}" class="manager-content">
                        <div class="manager-icon"><i class="fas fa-headset"></i></div>
                        <div class="manager-status">
                            <strong th:text="${ticket.estado == 'Abierto' ? 'Su ticket está en revisión.' : 
                                    ticket.estado == 'Pendiente' ? 'Su ticket está en progreso.' : 
                                    ticket.estado == 'Resuelto' ? 'Su ticket ha sido solucionado.' : 
                                    'Su ticket ha sido cerrado.'}">Estado del ticket</strong>
                            <p>Pronto un soportista se pondrá en contacto con usted.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para vista previa de imágenes -->
            <div id="imageModal" class="image-modal">
                <span class="close-modal"><i class="fa-solid fa-xmark"></i></span>
                <div class="modal-content-container">
                    <img id="modalImage" class="modal-content">
                        <div id="modalFileName" class="file-name-modal"></div>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Obtener elementos del DOM
                    const modal = document.getElementById('imageModal');
                    const modalImg = document.getElementById('modalImage');
                    const modalFileName = document.getElementById('modalFileName');
                    const closeBtn = document.querySelector('.close-modal');
                    const fileItems = document.querySelectorAll('.file-item');
                    const body = document.body;

                    // Precargar imagen para evitar saltos
                    function preloadImage(url) {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.onload = () => resolve(url);
                            img.onerror = () => reject();
                            img.src = url;
                        });
                    }

                    // Configurar evento de clic para los items de archivo
                    fileItems.forEach(item => {
                        item.addEventListener('click', async function (e) {
                            // Evitar abrir el modal si se hizo clic en el botón eliminar
                            if (!e.target.closest('.delete-button')) {
                                const imgSrc = this.getAttribute('data-src');
                                const fileName = this.querySelector('.file-name').textContent;

                                // Establecer texto del nombre del archivo
                                modalFileName.textContent = fileName;

                                try {
                                    // Precargar la imagen antes de mostrar el modal
                                    await preloadImage(imgSrc);

                                    // Establecer la fuente de la imagen
                                    modalImg.src = imgSrc;

                                    // Agregar clase para prevenir scroll en el body
                                    body.classList.add('modal-open');

                                    // Mostrar el modal con flexbox para centrado
                                    modal.style.display = 'flex';
                                } catch (error) {
                                    console.error('Error al cargar la imagen:', error);
                                    alert('No se pudo cargar la imagen. Por favor, inténtelo nuevamente.');
                                }
                            }
                        });
                    });

                    // Función para cerrar el modal
                    function closeModal() {
                        modal.style.display = 'none';
                        body.classList.remove('modal-open');
                    }

                    // Cerrar modal al hacer clic en la X
                    closeBtn.addEventListener('click', closeModal);

                    // Cerrar modal al hacer clic fuera de la imagen
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            closeModal();
                        }
                    });

                    // Cerrar modal con tecla ESC
                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape' && modal.style.display === 'flex') {
                            closeModal();
                        }
                    });

                    // Manejar cambios de tamaño de ventana
                    window.addEventListener('resize', function () {
                        if (modal.style.display === 'flex') {
                            // Ajustar tamaño de la imagen si es necesario
                            modalImg.style.maxHeight = '85vh';
                            modalImg.style.maxWidth = '95%';
                        }
                    });
                });
            </script>
        </section>


        <section th:fragment="usuarios-listado">
            <div class="container-fluid">
                <h2 class="mb-4">Administrar Colaboradores</h2>

                <!-- Mensaje de Exito -->
                <div th:if="${mensaje}" class="alert alert-success" role="alert">
                    <span th:text="${mensaje}"></span>
                </div>

                <!-- Boton para agregar un nuevo usuario -->
                <div class="mb-3">
                    <button id="btnCreateUser" class="btn btn-primary" onclick="openNeonModal('neonCreateModal')">
                        <i class="fas fa-plus"></i> Agregar Nuevo Usuario
                    </button>
                </div>

                <!-- Pagination Header -->
                <div class="table-header">
                    <div class="pagination-left">
                        <span>Mostrar</span>
                        <select id="recordsPerPage" class="records-select">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span>registros por página</span>
                    </div>
                    <div class="pagination-center">
                        <span id="pageInfo" th:text="'Mostrando ' + ${start} + ' a ' + ${end} + ' de ' + ${totalItems} + ' registros'">
                            Mostrando 1 a 10 de 50 registros
                        </span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=0,size=${pageSize})} + '\''"
                                th:disabled="${currentPage == 0}">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${currentPage-1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage == 0}">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <div class="page-numbers" id="pageNumbers">
                            <button th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                                    th:class="'page-number ' + ${pageNum == currentPage ? 'active' : ''}"
                                    th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${pageNum},size=${pageSize})} + '\''"
                                    th:text="${pageNum + 1}">1</button>
                        </div>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${currentPage+1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage >= totalPages - 1}">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="pagination-btn" th:onclick="'window.location.href=\'' + @{/usuario/listado(page=${totalPages-1},size=${pageSize})} + '\''"
                                th:disabled="${currentPage >= totalPages - 1}">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Contenedor de la Tabla -->
                <div class="table-container">
                    <table class="tickets-table table-resizable">
                        <thead>
                            <tr>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">ID</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Imagen</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Código</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Nombre Completo</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Correo Electrónico</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Departamento</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Teléfono</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Roles</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Estado</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Última Conexión</div>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort"></i>
                                        </div>
                                        <div class="resizer"></div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <div class="header-text">Acciones</div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario : ${usuarios}">
                                <td th:text="${usuario.idUsuario}"></td>
                                <td style="padding: 2px;">
                                    <img th:if="${usuario.imagen != null}" 
                                         th:src="@{/usuario/imagen/{id}(id=${usuario.idUsuario})}" 
                                         class="user-img" style="width: 35px; height: 35px; display: block; margin: 0 auto;">
                                        <span th:unless="${usuario.imagen != null}" class="badge badge-desactivado" style="display: block; text-align: center;">Sin imagen</span>
                                </td>
                                <td th:text="${usuario.codigo} ?: 'Sin código'"></td>
                                <td th:text="${usuario.nombre + ' ' + usuario.apellido} ?: 'Sin nombre'"></td>
                                <td th:text="${usuario.correoElectronico} ?: 'Sin correo'"></td>
                                <td th:text="${usuario.departamento} ?: 'Sin dpto.'"></td>
                                <td th:text="${usuario.numeroTelefono == '0' ? 'Sin teléfono' : usuario.numeroTelefono}"></td>
                                <td>
                                    <th:block th:if="${#lists.isEmpty(usuario.roles)}">
                                        <span class="badge badge-desactivado">Sin rol</span>
                                    </th:block>
                                    <span th:each="rol : ${usuario.roles}" 
                                          th:text="${rol.nombre}" 
                                          class="badge badge-abierto"></span>
                                </td>
                                <td>
                                    <span th:text="${usuario.activo ? 'Activo' : 'Inactivo'}" 
                                          th:class="${usuario.activo ? 'badge badge-resuelto' : 'badge badge-cancelado'}"></span>
                                </td>
                                <td th:text="${usuario.ultimaConexion != null} ? ${#dates.format(usuario.ultimaConexion, 'dd/MM/yyyy HH:mm')} : 'Sin conexión'"></td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn" style="padding: 4px 8px;" 
                                                th:data-id="${usuario.idUsuario}" 
                                                data-action="edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <a th:href="@{'/usuario/eliminar/' + ${usuario.idUsuario}}" 
                                           class="btn" style="padding: 4px 8px;">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(usuarios)}">
                                <td colspan="11" style="text-align: center;">No hay usuarios registrados</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal para Crear Usuario -->
            <div id="neonCreateModal" class="neon-modal">
                <div class="neon-modal-content">
                    <div class="neon-modal-header">
                        <h5 class="modal-title">Agregar Nuevo Usuario</h5>
                        <span class="close-modal" onclick="closeNeonModal('neonCreateModal')">&times;</span>
                    </div>
                    <div class="neon-modal-body">
                        <form id="formCreateUser" th:action="@{/usuario/crear}" method="post" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="nombre">Nombre:</label>
                                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="apellido">Apellido:</label>
                                        <input type="text" class="form-control" id="apellido" name="apellido" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label for="correoElectronico">Correo Electrónico:</label>
                                <input type="email" class="form-control" id="correoElectronico" name="correoElectronico" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="departamento">Departamento:</label>
                                        <select class="form-control" id="departamento" name="departamento">
                                            <option value="">Seleccionar departamento</option>
                                            <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="numeroTelefono">Teléfono:</label>
                                        <input type="text" class="form-control" id="numeroTelefono" name="numeroTelefono">
                                    </div>
                                </div>
                            </div>
                            <!-- En el modal de creación -->
                            <div class="form-group mb-3">
                                <label for="contrasena">Contraseña:</label>
                                <input type="password" class="form-control" id="contrasena" name="contrasena" required>
                            </div>
                            <div class="form-group mb-3">
                                <label for="imagenFile">Imagen de Perfil:</label>
                                <input type="file" class="form-control" id="imagenFile" name="imagenFile" accept="image/*">
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="activo" name="activo" checked>
                                    <label class="form-check-label" for="activo">Usuario Activo</label>
                            </div>
                            <div class="neon-modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeNeonModal('neonCreateModal')">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal para Editar Usuario -->
            <div id="neonEditModal" class="neon-modal">
                <div class="neon-modal-content">
                    <div class="neon-modal-header">
                        <h5 class="modal-title">Editar Usuario</h5>
                        <span class="close-modal" onclick="closeNeonModal('neonEditModal')">&times;</span>
                    </div>
                    <div class="neon-modal-body">
                        <form id="formEditUser" th:action="@{/usuario/editar}" method="post" enctype="multipart/form-data">
                            <input type="hidden" id="editUserId" name="idUsuario">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editNombre">Nombre:</label>
                                            <input type="text" class="form-control" id="editNombre" name="nombre" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editApellido">Apellido:</label>
                                            <input type="text" class="form-control" id="editApellido" name="apellido" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="editCorreoElectronico">Correo Electrónico:</label>
                                    <input type="email" class="form-control" id="editCorreoElectronico" name="correoElectronico" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editDepartamento">Departamento:</label>
                                            <select class="form-control" id="editDepartamento" name="departamento">
                                                <option value="">Seleccionar departamento</option>
                                                <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="editNumeroTelefono">Teléfono:</label>
                                            <input type="text" class="form-control" id="editNumeroTelefono" name="numeroTelefono">
                                        </div>
                                    </div>
                                </div>
                                <!-- En el modal de edición -->
                                <div class="form-group mb-3">
                                    <label for="editContrasena">Contraseña (dejar en blanco para mantener la actual):</label>
                                    <input type="password" class="form-control" id="editContrasena" name="contrasena">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="editImagenFile">Imagen de Perfil:</label>
                                    <input type="file" class="form-control" id="editImagenFile" name="imagenFile" accept="image/*">
                                        <div id="currentImageContainer" class="mt-2" style="display: none;">
                                            <p>Imagen actual:</p>
                                            <img id="currentImage" src="" alt="Imagen actual" style="max-width: 100px; max-height: 100px;">
                                        </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="editRol">Rol:</label>
                                    <select class="form-control" id="editRol" name="rol">
                                        <option value="ROL_ADMINISTRADOR">Administrador</option>
                                        <option value="ROL_SOPORTISTA">Soportista</option>
                                        <option value="ROL_USUARIO">Usuario</option>
                                    </select>
                                </div>
                                <div class="form-check mb-3">
                                    <input type="checkbox" class="form-check-input" id="editActivo" name="activo">
                                        <label class="form-check-label" for="editActivo">Usuario Activo</label>
                                </div>
                                <div class="neon-modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="closeNeonModal('neonEditModal')">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal para Confirmar Eliminación -->
            <div id="neonDeleteModal" class="neon-modal">
                <div class="neon-modal-content" style="max-width: 500px;">
                    <div class="neon-modal-header">
                        <h5 class="modal-title">Confirmar Eliminación</h5>
                        <span class="close-modal" onclick="closeNeonModal('neonDeleteModal')">&times;</span>
                    </div>
                    <div class="neon-modal-body">
                        <p>¿Está seguro que desea eliminar al usuario <span id="deleteUserName" class="font-weight-bold"></span>?</p>
                        <p class="text-danger">Esta acción no se puede deshacer.</p>
                        <form id="formDeleteUser" method="post">
                            <input type="hidden" id="deleteUserId" name="id">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <div class="neon-modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="closeNeonModal('neonDeleteModal')">Cancelar</button>
                                    <button type="submit" class="btn btn-danger">Eliminar</button>
                                </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Global Loader -->
            <div id="globalLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
                <div style="color: white; font-size: 24px;">
                    <i class="fas fa-spinner fa-spin"></i> Procesando...
                </div>
            </div>

            <!-- Toast de Éxito -->
            <div id="toast-success" class="toast-modal toast-success">
                <div class="toast-content">
                    <p class="toast-message">
                        <i class="toast-icon fas fa-check-circle"></i>
                        <span>Operación exitosa</span>
                    </p>
                    <span class="toast-close">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>

            <!-- Toast de Error -->
            <div id="toast-error" class="toast-modal toast-error">
                <div class="toast-content">
                    <p class="toast-message">
                        <i class="toast-icon fas fa-exclamation-circle"></i>
                        <span>Ocurrió un error</span>
                    </p>
                    <span class="toast-close">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>

            <!-- Estilos CSS para los modales -->
            <style>
                .neon-modal {
                    display: none;
                    position: fixed;
                    z-index: 1050;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgba(0, 0, 0, 0.5);
                    animation: fadeIn 0.3s;
                }

                .neon-modal-content {
                    position: relative;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 0;
                    border: 1px solid #888;
                    border-radius: 8px;
                    width: 80%;
                    max-width: 800px;
                    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
                    animation: slideIn 0.3s;
                }

                .neon-modal-header {
                    padding: 15px 20px;
                    border-bottom: 1px solid #e9ecef;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .neon-modal-body {
                    padding: 20px;
                    max-height: calc(100vh - 200px);
                    overflow-y: auto;
                }

                .neon-modal-footer {
                    padding: 15px 20px;
                    border-top: 1px solid #e9ecef;
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                }

                .close-modal {
                    color: #aaa;
                    float: right;
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                }

                .close-modal:hover,
                .close-modal:focus {
                    color: black;
                    text-decoration: none;
                }

                .user-img {
                    width: 32px;
                    height: 32px;
                    border-radius: 10%;
                    object-fit: cover;
                }

                @keyframes fadeIn {
                    from {
                        opacity: 0
                    }
                    to {
                        opacity: 1
                    }
                }

                @keyframes slideIn {
                    from {
                        transform: translateY(-50px);
                        opacity: 0;
                    }
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
            </style>


            <script>
                // Funciones básicas para abrir/cerrar modals
                function openNeonModal(modalId) {
                    console.log("Abriendo modal:", modalId);
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.style.display = "block";
                        document.body.style.overflow = "hidden";
                        // Enfocar el primer campo input del modal
                        const firstInput = modal.querySelector('input:not([type="hidden"]');
                        if (firstInput) {
                            firstInput.focus();
                        }
                    } else {
                        console.error("Modal no encontrado:", modalId);
                    }
                }

                function closeNeonModal(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.style.display = "none";
                        document.body.style.overflow = "auto";
                        // Resetear el formulario si existe
                        const form = modal.querySelector('form');
                        if (form) {
                            form.reset();
                        }
                    }
                }

// Cerrar modal al hacer clic fuera del contenido
                window.onclick = function (event) {
                    if (event.target.classList.contains('neon-modal')) {
                        closeNeonModal(event.target.id);
                    }
                };

// Cerrar modal con ESC
                document.addEventListener('keydown', function (event) {
                    if (event.key === 'Escape') {
                        const openModal = document.querySelector('.neon-modal[style="display: block;"]');
                        if (openModal) {
                            closeNeonModal(openModal.id);
                        }
                    }
                });

// Función para cargar los datos del usuario en el modal de edición
                function loadUserData(userId) {
                    showLoader(true);

                    fetch(`/usuario/editar/${userId}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                            .then(response => {
                                // Verificar si la respuesta es JSON
                                const contentType = response.headers.get('content-type');
                                if (!contentType || !contentType.includes('application/json')) {
                                    return response.text().then(text => {
                                        throw new Error(`Respuesta no JSON: ${text.substring(0, 100)}...`);
                                    });
                                }

                                if (!response.ok) {
                                    return response.json().then(err => {
                                        throw new Error(err.error || `Error HTTP: ${response.status}`);
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }

                                if (!data.usuario) {
                                    throw new Error('Datos de usuario no recibidos en la respuesta');
                                }

                                const usuario = data.usuario;
                                const roles = data.roles || [];

                                // Llenar el formulario
                                document.getElementById('editUserId').value = usuario.idUsuario;
                                document.getElementById('editNombre').value = usuario.nombre || '';
                                document.getElementById('editApellido').value = usuario.apellido || '';
                                document.getElementById('editCorreoElectronico').value = usuario.correoElectronico || '';
                                document.getElementById('editDepartamento').value = usuario.departamento || '';
                                document.getElementById('editNumeroTelefono').value = usuario.numeroTelefono || '';
                                document.getElementById('editActivo').checked = usuario.activo;

                                // Imagen actual
                                const currentImageContainer = document.getElementById('currentImageContainer');
                                const currentImage = document.getElementById('currentImage');

                                if (usuario.tieneImagen) {
                                    currentImage.src = `/usuario/imagen/${usuario.idUsuario}?${new Date().getTime()}`;
                                    currentImageContainer.style.display = 'block';
                                } else {
                                    currentImageContainer.style.display = 'none';
                                }

                                // Seleccionar el primer rol si existe
                                const rolSelect = document.getElementById('editRol');
                                if (roles && roles.length > 0) {
                                    rolSelect.value = roles[0];
                                } else {
                                    rolSelect.value = '';
                                }

                                openNeonModal('neonEditModal');
                            })
                            .catch(error => {
                                console.error('Error al cargar usuario:', error);
                                showToast('error', `Error al cargar datos del usuario: ${error.message}`);

                                // Mostrar detalles del error en consola
                                if (error.response) {
                                    error.response.text().then(text => {
                                        console.error('Respuesta completa del error:', text);
                                    });
                                }
                            })
                            .finally(() => {
                                showLoader(false);
                            });
                }

// Función para manejar el envío del formulario de creación
                function handleCreateFormSubmit(event) {
                    event.preventDefault();

                    const form = event.target;
                    const formData = new FormData(form);
                    const submitButton = form.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;

                    // Validar contraseña si es necesario
                    const password = formData.get('contrasena');
                    if (password.length < 3) {
                        showToast('error', 'La contraseña debe tener al menos 3 caracteres');
                        return;
                    }

                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
                    submitButton.disabled = true;

                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                            .then(response => {
                                if (response.redirected) {
                                    window.location.href = response.url;
                                } else if (!response.ok) {
                                    return response.json().then(err => {
                                        throw new Error(err.message || 'Error al crear usuario');
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                showToast('success', 'Usuario creado exitosamente');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            })
                            .catch(error => {
                                console.error('Error al crear usuario:', error);
                                showToast('error', error.message);
                            })
                            .finally(() => {
                                submitButton.innerHTML = originalButtonText;
                                submitButton.disabled = false;
                            });
                }

                // Función para manejar el envío del formulario de edición
                function handleEditFormSubmit(event) {
                    event.preventDefault();

                    const form = event.target;
                    const formData = new FormData(form);
                    const submitButton = form.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;

                    // Si la contraseña está vacía, no la incluimos en el FormData
                    if (document.getElementById('editContrasena').value === '') {
                        formData.delete('contrasena');
                    }

                    // Asegurarnos de que el valor de "activo" sea un booleano para el servidor
                    formData.set('activo', document.getElementById('editActivo').checked);

                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                    submitButton.disabled = true;
                    showLoader(true);

                    fetch('/usuario/actualizar', {
                        method: 'POST',
                        body: formData
                    })
                            .then(response => {
                                const contentType = response.headers.get('content-type');
                                if (contentType && contentType.includes('application/json')) {
                                    return response.json();
                                } else {
                                    // Si no es JSON, consideramos éxito pero manejamos adecuadamente
                                    if (response.ok) {
                                        return {success: true, mensaje: 'Usuario actualizado correctamente'};
                                    } else {
                                        throw new Error('Error en la respuesta del servidor');
                                    }
                                }
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }

                                // Cerrar el modal primero
                                closeNeonModal('neonEditModal');

                                // Luego mostrar el toast de éxito
                                setTimeout(() => {
                                    showToast('success', data.mensaje || 'Usuario actualizado correctamente');
                                }, 300);

                                // Finalmente recargar la página después de un breve retraso
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            })
                            .catch(error => {
                                console.error('Error al actualizar usuario:', error);
                                showToast('error', error.message || 'Error al actualizar usuario');
                            })
                            .finally(() => {
                                submitButton.innerHTML = originalButtonText;
                                submitButton.disabled = false;
                                showLoader(false);
                            });
                }

// Función para manejar el envío del formulario de eliminación
                function handleDeleteFormSubmit(event) {
                    event.preventDefault();

                    const form = event.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;

                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
                    submitButton.disabled = true;

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                        }
                    })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(err => {
                                        throw new Error(err.message || 'Error al eliminar usuario');
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                showToast('success', 'Usuario eliminado correctamente');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            })
                            .catch(error => {
                                console.error('Error al eliminar usuario:', error);
                                showToast('error', error.message);
                            })
                            .finally(() => {
                                submitButton.innerHTML = originalButtonText;
                                submitButton.disabled = false;
                                closeNeonModal('neonDeleteModal');
                            });
                }

// Función para abrir el modal de eliminación
                function openDeleteModal(userId, userName) {
                    document.getElementById('deleteUserId').value = userId;
                    document.getElementById('deleteUserName').textContent = userName;
                    document.getElementById('formDeleteUser').setAttribute('action', `/usuario/eliminar/${userId}`);
                    openNeonModal('neonDeleteModal');
                }

// Función para mostrar notificaciones
                function showToast(type, message) {
                    const toast = document.getElementById(`toast-${type}`);
                    if (!toast)
                        return;

                    const messageElement = toast.querySelector('.toast-message span');
                    if (messageElement) {
                        messageElement.textContent = message;
                    }

                    toast.style.display = 'block';

                    // Cerrar automáticamente después de 5 segundos
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 5000);
                }

// Función para mostrar/ocultar loader
                function showLoader(show) {
                    const loader = document.getElementById('globalLoader');
                    if (loader) {
                        loader.style.display = show ? 'flex' : 'none';
                    }
                }

// Configurar eventos después de que el DOM esté cargado
                document.addEventListener('DOMContentLoaded', function () {
                    // Configurar formulario de creación
                    const createForm = document.getElementById('formCreateUser');
                    if (createForm) {
                        createForm.addEventListener('submit', handleCreateFormSubmit);
                    }

                    // Configurar formulario de edición
                    const editForm = document.getElementById('formEditUser');
                    if (editForm) {
                        editForm.addEventListener('submit', handleEditFormSubmit);
                    }

                    // Configurar formulario de eliminación
                    const deleteForm = document.getElementById('formDeleteUser');
                    if (deleteForm) {
                        deleteForm.addEventListener('submit', handleDeleteFormSubmit);
                    }

                    // Delegación de eventos para los botones de edición
                    document.addEventListener('click', function (e) {
                        // Botones de edición
                        if (e.target.closest('button[data-action="edit"]')) {
                            e.preventDefault();
                            const button = e.target.closest('button[data-action="edit"]');
                            const userId = button.getAttribute('data-id');
                            if (!userId) {
                                showToast('error', 'ID de usuario no válido');
                                return;
                            }
                            loadUserData(userId);
                        }

                        // Enlaces de eliminación
                        if (e.target.closest('a[href^="/usuario/eliminar/"]')) {
                            e.preventDefault();
                            const link = e.target.closest('a[href^="/usuario/eliminar/"]');
                            const userId = link.getAttribute('href').split('/').pop();
                            const userName = link.closest('tr').querySelector('td:nth-child(3)').textContent;
                            openDeleteModal(userId, userName);
                        }
                    });

                    // Configurar cambio en el selector de registros por página
                    const recordsPerPage = document.getElementById('recordsPerPage');
                    if (recordsPerPage) {
                        recordsPerPage.addEventListener('change', function () {
                            const size = this.value;
                            window.location.href = `/usuario/listado?page=0&size=${size}`;
                        });

                        // Establecer el valor seleccionado actual
                        const urlParams = new URLSearchParams(window.location.search);
                        const currentSize = urlParams.get('size') || '10';
                        recordsPerPage.value = currentSize;
                    }

                    // Configurar cierre de toasts
                    document.querySelectorAll('.toast-close').forEach(closeBtn => {
                        closeBtn.addEventListener('click', function () {
                            const toast = this.closest('.toast-modal');
                            if (toast) {
                                toast.style.display = 'none';
                            }
                        });
                    });
                });
            </script>
        </section>
    </body>
</html>