<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/plantilla :: head}">
        <title>Centro de Soporte</title>
        <meta charset="UTF-8"/>
    </head>

    <body>
        <section th:fragment="properties-section">
            <input type="hidden" id="solicitanteId" th:value="${ticket.solicitante.idUsuario}">
            <input type="hidden" id="estadoTicket" th:value="${ticket.estado}" />
            <input type="hidden" id="usuarioActualId" th:value="${usuarioActual?.idUsuario}">
            <input type="hidden" id="usuarioActualRol" th:value="${usuarioActual?.roles?.get(0)?.nombre}">

            <!-- Viewer Modal Unificado -->
            <div class="modal-viewer" id="fileViewer">
                <button class="close-viewer" onclick="closeViewer()">&times;</button>
                <button class="file-nav prev-file" onclick="changeFile(-1)">&#10094;</button>
                <div class="modal-content-viewer">
                    <!-- Contenedor para imágenes -->
                    <div class="image-container" id="imageContainer">
                        <img src="" alt="Vista previa" class="modal-image-viewer" id="currentImage">
                    </div>

                    <!-- Contenedor para PDF -->
                    <div class="pdf-container" id="pdfContainer">
                        <iframe id="pdfViewerContent" class="pdf-viewer-content" frameborder="0"></iframe>
                    </div>

                    <div class="file-counter" id="fileCounter"></div>
                    <div class="thumbnail-container" id="thumbnailContainer"></div>
                </div>
                <button class="file-nav next-file" onclick="changeFile(1)">&#10095;</button>
            </div>

            <div class="back-button-container">
                <a class="btn btn-outline-secondary back-button">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>

                <input type="hidden" id="ticketId" th:value="${ticket.idTicket}">

                <!-- Botón Atender Ticket -->
                <button th:if="${(ticket.estado != 'Cerrado' and ticket.estado != 'Desactivado') and
                        (ticket.asignadoPara?.idUsuario != usuarioActual.idUsuario or ticket.estado == 'Cancelado') and
                        (esAdmin or esSoportista or 
                        (ticket.estado == 'Abierto' and ticket.asignadoPara == null) or
                        ticket.estado == 'Cancelado')}"
                        type="button" 
                        id="btnAtenderTicket" 
                        class="btn btn-outline-primary" 
                        th:data-ticket-id="${ticket.idTicket}"
                        onclick="atenderTicket(this.getAttribute('data-ticket-id'))">
                    <i class="fa-solid fa-clipboard-check"></i> Atender Ticket
                </button>

                <!-- Boton Actualizar Ticket -->
                <button th:if="${(esAdmin or (ticket.estado != 'Desactivado' and ticket.estado != 'Cerrado' and 
                        (ticket.solicitante.idUsuario == usuarioActual.idUsuario and usuarioActual.roles.?[nombre == 'ROL_SOPORTISTA'].size() > 0))) or 
                        (esAdmin and ticket.estado != 'Desactivado') or
                        (ticket.estado == 'Cerrado' and ticket.solicitante.idUsuario == usuarioActual.idUsuario and 
                        ticket.solicitante.roles.?[nombre == 'ROL_SOPORTISTA'].size() > 0)}"
                        type="button" 
                        class="btn btn-outline-primary" 
                        onclick="toggleEditMode()">
                    <i class="fa-solid fa-pen"></i> Actualizar Ticket
                </button>

                <!-- Botón Asignar/Reasignar Ticket -->
                <button th:if="${(esAdmin or (ticket.estado != 'Desactivado' and 
                        ((ticket.asignadoPara != null and usuarioActual != null and ticket.asignadoPara.idUsuario == usuarioActual.idUsuario) or
                        (ticket.estado == 'Cerrado' and ticket.solicitante.idUsuario == usuarioActual.idUsuario and 
                        ticket.solicitante.roles.?[nombre == 'ROL_SOPORTISTA'].size() > 0)))) or 
                        (esAdmin and ticket.estado != 'Desactivado' and ticket.asignadoPara != null)}" 
                        type="button" 
                        class="btn btn-outline-primary"
                        onclick="openAssignTicketsModal()">
                    <i th:class="${ticket.asignadoPara != null ? 'fa-solid fa-user-pen' : 'fa-solid fa-user-plus'}"></i>
                    <span th:text="${ticket.asignadoPara != null ? 'Reasignar Ticket' : 'Asignar Ticket'}"></span>
                </button>

                <!-- Botón Reabrir Ticket -->
                <button th:if="${ticket.estado == 'Resuelto' or ticket.estado == 'Cerrado'}"
                        type="button" 
                        class="btn btn-outline-primary" 
                        onclick="openReabrirTicketModal()">
                    <i class="fa-solid fa-rotate"></i> Reabrir Ticket
                </button>

                <!-- Botón Cerrar Ticket -->
                <button th:if="${ticket.asignadoPara != null and ticket.estado != 'Resuelto' and ticket.estado != 'Desactivado' and ticket.estado != 'Cerrado'}" 
                        type="button" 
                        class="btn btn-outline-success" 
                        id="btnCerrarTicket"
                        onclick="verificarPrioridadYCerrar()">
                    <i class="fa-regular fa-circle-check"></i> Cerrar Ticket
                </button>

                <!-- Botón Desactivar Ticket -->
                <button type="button" 
                        class="btn btn-danger" 
                        id="desactivarBtn" 
                        th:data-ticket-id="${ticket.idTicket}"
                        th:disabled="${ticket.estado == 'Desactivado'}"
                        onclick="openDeactivateTicketModal()">
                    <i class="fa-solid fa-ban"></i> Desactivar Ticket
                </button>
            </div>

            <div class="container">
                <!-- Sidebar -->
                <div class="ticket-summary card">
                    <h2 class="ticket-title">Resumen del Ticket</h2>
                    <div class="info-row">
                        <span class="info-label">Código:</span>
                        <span class="badge badge-codigo" th:text="'#' + ${ticket.codigo}">#TIC12345678</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Estado:</span>
                        <span th:class="'badge badge-' + ${#strings.toLowerCase(ticket.estado)}"
                              th:text="${ticket.estado}">(Estado)</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Prioridad:</span>
                        <span th:class="'badge badge-' + ${ticket.prioridad == 'Sin Asignar' ? 'sin-asignar' : #strings.toLowerCase(ticket.prioridad)}"
                              th:text="${ticket.prioridad == 'Sin Asignar' ? 'Sin Asignar' : ticket.prioridad}">
                            (Prioridad)
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Categoria:</span>
                        <span class="badge badge-categorias" th:text="${ticket.categoria}">#TIC12345678</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha de Apertura:</span>
                        <span class="info-value" th:text="${#dates.format(ticket.fechaApertura, 'dd/MM/yyyy')}"></span>
                    </div>
                    <div class="info-row" th:if="${ticket.estado == 'Resuelto'}">
                        <span class="info-label">Cierre automático en:</span>
                        <span class="info-value" id="tiempoCierreRestante">Calculando...</span>
                    </div>

                    <button class="action-button" id="btnAsignarPrioridad"
                            onclick="openPrioridadModal()"
                            th:disabled="${(ticket.estado == 'Resuelto' or ticket.estado == 'Desactivado' or ticket.estado == 'Cerrado')}">
                        <i class="fa-solid fa-thumbtack"></i> Asignar Prioridad
                    </button>
                </div>

                <!-- Main Content -->
                <div class="ticket-details">
                    <div class="tabs">
                        <button class="tab-button active" data-tab="tab1">
                            <i class="fa-solid fa-list-ul"></i>
                            Detalles del Ticket
                        </button>
                        <button class="tab-button" data-tab="tab2">
                            <i class="fa-solid fa-comments"></i>
                            Respuestas
                        </button>
                        <button class="tab-button" data-tab="tab3" 
                                th:if="${usuarioActual.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0}">
                            <i class="fa-solid fa-clock-rotate-left"></i>
                            Auditoria
                        </button>
                    </div>
                    <div class="tab-content">
                        <div id="tab1" class="tab-pane active">
                            <div class="card" id="card-tabs">
                                <form>
                                    <div class="grid grid-2">
                                        <div class="form-group">
                                            <label for="solicitante" class="form-label">Solicitante</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="solicitante" 
                                                       th:value="${ticket.solicitante != null ? 
                                                       (ticket.solicitante.apellido != null && !ticket.solicitante.apellido.isEmpty() ? 
                                                       ticket.solicitante.nombre + ' ' + ticket.solicitante.apellido + ' (' + ticket.solicitante.codigo + ')' : 
                                                       ticket.solicitante.nombre + ' (' + ticket.solicitante.codigo + ')') : 
                                                       'Sin Asignar'}" 
                                                       readonly>
                                                <button type="button" 
                                                        id="infoUsuario" 
                                                        class="btn btn-outline-secondary popover-btn" 
                                                        data-popover="Ver Perfil del Solicitante"
                                                        th:onclick="'window.location.href=\'/tickets/perfil-solicitante/' + ${ticket.solicitante.idUsuario} + '\''">
                                                    <i class="fa-solid fa-id-badge"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="grid grid-2">
                                            <div class="form-group">
                                                <!-- Campo Editable por medio del buttom Actualizar Ticket -->
                                                <label for="codigo" class="form-label">Código</label>
                                                <input type="text" class="form-control" id="codigo" th:value="${ticket.codigo}" readonly maxlength="11">
                                            </div>
                                            <div class="form-group">
                                                <label for="impacto" class="form-label">Impacto</label>
                                                <select class="form-control no-interaction" id="impacto" th:value="${#strings.isEmpty(ticket.impacto) ? 'Sin Asignar' : ticket.impacto}">
                                                    <option th:selected="${ticket.impacto == 'Mínimo'}" value="Mínimo">Mínimo</option>
                                                    <option th:selected="${ticket.impacto == 'Regular'}" value="Regular">Regular</option>
                                                    <option th:selected="${ticket.impacto == 'Importante'}" value="Importante">Importante</option>
                                                    <option th:selected="${ticket.impacto == 'Urgente'}" value="Urgente">Urgente</option>
                                                    <option th:selected="${ticket.impacto == null or ticket.impacto == 'Sin Asignar'}" value="Sin Asignar">Sin Asignar</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-2">
                                        <div class="grid grid-2">
                                            <div class="form-group">
                                                <label for="fechaApertura" class="form-label">Fecha de Apertura</label>
                                                <input type="text" class="form-control" id="fechaApertura" 
                                                       th:value="${#dates.format(ticket.fechaApertura, 'dd')} + ' de ' + ${#dates.format(ticket.fechaApertura, 'MMMM')} + ' del ' + ${#dates.format(ticket.fechaApertura, 'yyyy')} + ' - ' + ${#dates.format(ticket.fechaApertura, 'HH:mm:ss')}" 
                                                       readonly>
                                            </div>
                                            <div class="form-group">
                                                <label for="categoria" class="form-label">Categoría</label>
                                                <select class="form-control no-interaction" id="categoria" th:value="${ticket.categoria}">
                                                    <option th:each="categoria : ${categoriasActivas}" 
                                                            th:value="${categoria.nombre}"
                                                            th:text="${categoria.nombre}"
                                                            th:selected="${ticket.categoria == categoria.nombre}">
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="grid grid-2">
                                            <!-- Campo Editable por medio del buttom Actualizar Ticket -->
                                            <div class="form-group">
                                                <label for="prioridad" class="form-label">Prioridad</label>
                                                <select class="form-control no-interaction" id="prioridad" th:value="${ticket.prioridad}">
                                                    <option th:selected="${ticket.prioridad == 'Bajo'}" value="Bajo">Bajo</option>
                                                    <option th:selected="${ticket.prioridad == 'Medio'}" value="Medio">Medio</option>
                                                    <option th:selected="${ticket.prioridad == 'Alto'}" value="Alto">Alto</option>
                                                    <option th:selected="${ticket.prioridad == 'Critico'}" value="Critico">Critico</option>
                                                    <option th:selected="${ticket.prioridad == 'Sin Asignar'}" value="Sin Asignar">Sin Asignar</option>
                                                </select>
                                            </div>
                                            <!-- Campo Editable por medio del buttom Actualizar Ticket -->
                                            <div class="form-group">
                                                <div class="label-with-icon">
                                                    <label for="estado" class="form-label">Estado</label>
                                                    <span class="password-info-icon">
                                                        <i class="fas fa-info-circle"></i>
                                                        <div class="password-popover-container">
                                                            <div class="password-popover">
                                                                <div class="password-popover-title">Información sobre Estados</div>
                                                                <div class="password-popover-content">
                                                                    <ul>
                                                                        <li><strong>Abierto (En Revisión):</strong> Ticket recién creado, pendiente de asignación.</li>
                                                                        <li><strong>Pendiente (En Progreso):</strong> Ticket asignado y en proceso de resolución.</li>
                                                                        <li><strong>Resuelto (Solucionado):</strong> Solución implementada, pendiente de cierre.</li>
                                                                        <li><strong>Cerrado (Cerrado):</strong> Ticket finalizado y confirmado.</li>
                                                                        <li><strong>Cancelado (Cancelado):</strong> Ticket cancelado por el solicitante.</li>
                                                                        <li><strong>Desactivado (Desactivado):</strong> Ticket deshabilitado para el usuario solicitante.</li>
                                                                    </ul>
                                                                    <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #e0e0e0; font-size: 11px; color: #555; font-style: italic;">
                                                                        <strong>Correspondencia de estados:</strong> La descripción entre paréntesis representa cómo visualiza el estado el usuario solicitante.
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </span>
                                                </div>
                                                <select class="form-control no-interaction" id="estado">
                                                    <option th:selected="${ticket.estado == 'Abierto'}">Abierto</option>
                                                    <option th:selected="${ticket.estado == 'Pendiente'}">Pendiente</option>
                                                    <option th:selected="${ticket.estado == 'Resuelto'}">Resuelto</option>
                                                    <option th:selected="${ticket.estado == 'Cerrado'}">Cerrado</option>
                                                    <option th:selected="${ticket.estado == 'Cancelado'}">Cancelado</option>
                                                    <option th:selected="${ticket.estado == 'Desactivado'}" 
                                                            th:unless="${esSoportista}">Desactivado</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-2">
                                        <div class="form-group">
                                            <label for="asignadoPara" class="form-label">Asignado para</label>
                                            <div class="input-group" 
                                                 th:classappend="${(ticket.estado == 'Resuelto' or ticket.estado == 'Desactivado')} ? 'no-button' : ''">
                                                <input type="text" class="form-control" id="asignadoPara" 
                                                       th:value="${ticket.asignadoPara != null ? 
                                                       (ticket.asignadoPara.apellido != null && !ticket.asignadoPara.apellido.isEmpty() ? 
                                                       ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido + ' (' + ticket.asignadoPara.codigo + ')' : 
                                                       ticket.asignadoPara.nombre + ' (' + ticket.asignadoPara.codigo + ')') : 
                                                       'Sin Asignar'}" 
                                                       readonly>
                                                <button type="button" 
                                                        id="asignarTicket" 
                                                        class="btn btn-outline-secondary popover-btn" 
                                                        data-popover="Asignar Ticket"
                                                        th:unless="${ticket.estado == 'Resuelto' or ticket.estado == 'Desactivado' or ticket.asignadoPara != null}">
                                                    <i class="fa-solid fa-user-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="grid grid-2">
                                            <div class="form-group">
                                                <label for="ultimaActualizacion" class="form-label">Última Fecha de Actualización</label>
                                                <input type="text" class="form-control" id="ultimaActualizacion" 
                                                       th:value="${#dates.format(ticket.fechaActualizacion, 'dd')} + ' de ' + ${#dates.format(ticket.fechaActualizacion, 'MMMM')} + ' del ' + ${#dates.format(ticket.fechaActualizacion, 'yyyy')} + ' - ' + ${#dates.format(ticket.fechaActualizacion, 'HH:mm:ss')}" 
                                                       readonly>
                                            </div>
                                            <div class="form-group">
                                                <label for="actualizadoPor" class="form-label">Actualizado por</label>
                                                <input type="text" class="form-control" id="actualizadoPor" 
                                                       th:value="${lastUpdatedBy != null ? lastUpdatedBy : 'Sistema'}" 
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Campo Editable por medio del buttom Actualizar Ticket -->
                                    <div class="form-group">
                                        <label for="breveDescripcion" class="form-label">Breve Descripción</label>
                                        <input type="text" class="form-control" id="breveDescripcion" th:value="${ticket.titulo}" readonly>
                                    </div>

                                    <!-- Campo Editable por medio del buttom Actualizar Ticket -->
                                    <div class="form-group">
                                        <label for="descripcion" class="form-label">Descripción</label>
                                        <textarea class="form-control" id="descripcion" readonly th:text="${ticket.descripcion}"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Archivos adjuntos</label>
                                        <div class="attachments-container" th:if="${tieneArchivos}">
                                            <div class="files-list">
                                                <div th:each="archivo : ${archivosInfo}" class="file-item"
                                                     th:attr="data-id=${archivo.id}, 
                                                     data-type=${archivo.tipo.startsWith('image/') ? 'image' : 'pdf'},
                                                     data-name=${archivo.nombre}">
                                                    <i th:class="${archivo.tipo.startsWith('image/') ? 'far fa-file-image file-icon' : 
                                                       (archivo.tipo == 'application/pdf' ? 'far fa-file-pdf file-icon' : 'far fa-file file-icon')}"></i>
                                                    <span class="file-name" th:text="${archivo.nombre}"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="no-attachments-message" th:unless="${tieneArchivos}">
                                            <div class="empty-state">
                                                <i class="far fa-folder-open"></i>
                                                <p>No se han adjuntado archivos a este ticket</p>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div id="tab2" class="tab-pane">
                            <!-- Contenido de la pestaña Respuestas -->
                            <div class="card" id="card-tabs" style="padding: 10px 20px 0px 20px;">
                                <div class="chat-header">
                                    <div class="chat-header-top">
                                        <h2>Chat de Soporte <span id="totalMessagesCounter">(0 mensajes)</span></h2>
                                        <div class="btn-refresh-container popover-btn" data-popover="Actualizar Mensajes">
                                            <button id="btnRefreshMessages" class="btn-refresh">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="chat-controls">
                                        <!-- Barra de búsqueda -->
                                        <div class="search-bar">
                                            <input type="text" id="searchMessages" placeholder="Buscar mensajes...">
                                            <button id="btnSearch"><i class="fa fa-search"></i></button>
                                        </div>
                                        <div class="filter-select">
                                            <select id="messageFilter">
                                                <option value="all">Todos</option>
                                                <option value="usuario">Solicitante</option>
                                                <option value="soporte">Soportista</option>
                                                <option value="notas" 
                                                        th:if="${usuarioActual.roles.?[nombre == 'ROL_SOPORTISTA'].size() > 0 or usuarioActual.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0}">
                                                    Notas Internas
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="chat-messages" id="chatMessagesContainer">
                                    <!-- Ejemplo de mensaje (Este no se muestra en la vista) -->
                                    <div class="message">
                                        <div class="message-header">
                                            <div class="user-avatar">
                                                <img src="/img/ImagenDefaultPerfil.jpg" alt="Foto de perfil">
                                            </div>
                                            <div class="message-info">
                                                <span class="user-name-message">Fernando</span>
                                                <span class="message-time">25/06/2025, 21:15:00</span>
                                            </div>
                                            <span class="user-role role-admin">Usuario</span>
                                        </div>
                                        <div class="message-content">
                                            Contenido del Mensaje...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tab3" class="tab-pane" th:if="${usuarioActual.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0}">
                            <div class="card" id="card-tabs" style="padding: 10px 20px 0px 20px;">
                                <div class="audit-header">
                                    <div class="audit-header-top">
                                        <h2>Historial de Auditoría</h2>
                                        <div class="btn-refresh-container popover-btn" data-popover="Actualizar Historial">
                                            <button id="btnRefreshAudit" class="btn-refresh">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="audit-header-top">
                                        <div class="audit-filters">
                                            <select class="form-control" id="auditFilter">
                                                <option value="all">Todas las acciones</option>
                                                <option value="CREACION">Creación</option>
                                                <option value="CANCELACION">Cancelado</option>
                                                <option value="ASIGNACION">Asignaciones</option>
                                                <option value="RESPUESTA_PUBLICA">Respuestas públicas</option>
                                                <option value="NOTA_INTERNA">Notas internas</option>
                                                <option value="ELIMINACION_RESPUESTA_PUBLICA">Eliminación de respuestas</option>
                                                <option value="ELIMINACION_NOTA_INTERNA">Eliminación de notas</option>
                                                <option value="CAMBIO_ESTADO">Cambios de estado</option>
                                                <option value="CIERRE">Cierres</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="audit-container">
                                    <div class="audit-timeline" id="auditTimeline">
                                        <!-- Los registros de auditoría se cargarán aquí dinámicamente -->
                                        <div class="loading-audit">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Cargando historial...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" id="card-message-manager">
                            <div class="response-header">
                                <h2>Responder Ticket</h2>
                               <button type="button" class="response-type public-response" id="responseType" onclick="toggleResponseType()">Respuesta Pública</button>
                            </div>
                            <form id="formResponderTicket" th:action="@{/tickets/responder/{id}(id=${ticket.idTicket})}" method="POST">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" id="esNotaInterna" name="esNotaInterna" value="false">
                                <input type="hidden" id="respuesta" name="respuesta">
                                <input type="hidden" id="respuestaTexto" name="respuestaTexto">

                                <!-- Editor TinyMCE -->
                                <div class="response-editor-container">
                                    <div id="editor"></div>
                                </div>

                                <div class="response-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Enviar Respuesta
                                    </button>
                                </div>
                            </form>

                            <!-- Mensaje para tickets cerrados - Visible para todos -->
                            <div th:if="${ticket.estado == 'Cerrado'}" class="status-message info">
                                <i class="fas fa-info-circle"></i>
                                <span>
                                    Este ticket está cerrado. 
                                    <!-- Mensaje para colaboradores (admin/soporte) -->
                                    <span th:if="${usuarioActual.roles.?[nombre == 'ROL_ADMINISTRADOR'].size() > 0 or 
                                          usuarioActual.roles.?[nombre == 'ROL_SOPORTISTA'].size() > 0}">
                                        Los usuarios no pueden responder mensajes en tickets que se encuentren cerrados.
                                    </span>
                                </span>
                            </div>

                            <!-- Mensaje para tickets desactivados -->
                            <div th:if="${ticket.estado == 'Desactivado'}" class="status-message warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Este ticket está desactivado. No se permiten más mensajes.</span>
                            </div>
                        </div>

                        <!-- Modal de Asignar Prioridad -->
                        <div class="modal-overlay" id="prioridadModalOverlay">
                            <div class="modal">
                                <div class="modal-header">
                                    <h2 class="modal-title">Asigne la prioridad estimada según el valor de cada celda</h2>
                                    <p class="modal-description">Una vez se actualice la prioridad del ticket, el usuario solicitante quedará a la espera de la resolución correspondiente. Además, se habilitará la opción para cerrar el ticket.</p>
                                </div>

                                <div class="modal-body">
                                    <!-- Usa Thymeleaf para pasar el ID del ticket -->
                                    <form th:action="@{/tickets/asignar-prioridad/{id}(id=${ticket.idTicket})}" method="POST">
                                        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                                        <div class="form-grid">
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label class="form-label" for="categoria">Categoría</label>
                                                    <div class="form-control">Hardware</div>
                                                </div>

                                                <div class="form-group">
                                                    <label class="form-label" for="impacto">Impacto</label>
                                                    <div class="form-control">Medio</div>
                                                </div>

                                                <div class="form-group">
                                                    <label class="form-label" for="prioridad">Prioridad</label>
                                                    <select class="form-select" id="prioridadSelect" name="prioridad" onchange="habilitarBoton()">
                                                        <!-- Mostrar "Sin Asignar" solo si la prioridad actual es "Sin Asignar" -->
                                                        <option th:if="${ticket.prioridad == 'Sin Asignar'}" value="Sin Asignar" th:selected="${ticket.prioridad == 'Sin Asignar'}">Sin Asignar</option>
                                                        <option value="Bajo" th:selected="${ticket.prioridad == 'Bajo'}">Bajo</option>
                                                        <option value="Medio" th:selected="${ticket.prioridad == 'Medio'}">Medio</option>
                                                        <option value="Alto" th:selected="${ticket.prioridad == 'Alto'}">Alto</option>
                                                        <option value="Critico" th:selected="${ticket.prioridad == 'Critico'}">Critico</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn" id="btnActualizarPrioridad" disabled>Actualizar Prioridad</button>
                                    <button type="button" class="btn btn-outline" id="closePrioridadModalBtn">Cerrar</button>
                                </div>
                                </form>
                            </div>
                        </div>

                        <!-- Modal para confirmar el cierre del ticket -->
                        <div class="modal-overlay" id="resolveTicketModalOverlay">
                            <div class="modal">
                                <div class="modal-header">
                                    <h2 class="modal-title">Confirmar Cierre del Ticket</h2>
                                </div>
                                <form th:action="@{/tickets/cerrarTicket}" method="post">
                                    <div class="modal-body">
                                        <input type="hidden" name="idTicket" th:value="${ticket.idTicket}">
                                        <div>
                                            <p>¿Está seguro que desea cerrar el ticket?</p>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closeResolveTicketModal()">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Cerrar Ticket</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Modal para mostrar error si no hay prioridad o usuario asignado -->
                        <div class="modal-overlay" id="errorPriorityModalOverlay">
                            <div class="modal">
                                <div class="modal-header">
                                    <h2 class="modal-title">Requisitos no cumplidos</h2>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <p>Para cerrar un ticket primero se le debe asignar un nivel de prioridad y un usuario responsable.</p>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="closeErrorPriorityModal()">Aceptar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal para asignar tickets -->
                        <div class="modal-overlay" id="assignTicketsModalOverlay">
                            <div class="modal assign-modal">
                                <div class="modal-header">
                                    <h2 class="modal-title">Asignar Ticket</h2>
                                    <p class="modal-description">Seleccione un soportista o administrador para asignar el ticket.</p>
                                </div>

                                <div class="modal-body">
                                    <!-- Campo de búsqueda mejorado -->
                                    <div class="form-group">
                                        <label class="form-label" for="soportistaSearchInput">Buscar soportista/administrador</label>
                                        <div class="search-input-container">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="text" 
                                                   class="form-control search-input" 
                                                   id="soportistaSearchInput" 
                                                   placeholder="Buscar por nombre, código o rol..."
                                                   autocomplete="off">
                                            <button type="button" 
                                                    class="clear-search-btn" 
                                                    id="clearSearchBtn" 
                                                    title="Limpiar búsqueda">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Contenedor de resultados flotante -->
                                    <div class="floating-results-container" id="floatingResultsContainer">
                                        <!-- Mensaje de carga -->
                                        <div id="loadingMessage" class="loading-message" style="display: none;">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Cargando soportistas...</span>
                                        </div>

                                        <!-- Mensaje de error -->
                                        <div id="errorMessage" class="error-message" style="display: none;">
                                            Error al cargar los soportistas
                                        </div>

                                        <!-- Lista de soportistas flotante -->
                                        <div class="floating-results-list" id="soportistasList">
                                            <!-- Los soportistas se cargarán aquí dinámicamente -->
                                        </div>
                                    </div>

                                    <!-- Resumen del ticket a asignar -->
                                    <div class="ticket-summary-section">
                                        <div class="section-header">
                                            <i class="fas fa-ticket-alt"></i>
                                            <span>Resumen de tickets (1 ticket)</span>
                                        </div>
                                        <div class="ticket-group">
                                            <div class="ticket-group-header">
                                                <div class="group-elements">
                                                    <span class="badge" 
                                                          th:classappend="${ticket.prioridad == 'Sin Asignar'} ? 
                                                          'badge-sin-asignar' : 
                                                          'badge-' + ${#strings.toLowerCase(#strings.replace(ticket.prioridad, ' ', '-'))}">
                                                        <span th:text="${ticket.prioridad == 'Sin Asignar' ? 'Sin Asignar' : ticket.prioridad}"></span>
                                                    </span>
                                                    <span class="badge badge-categorias" style="margin-left: 8px;">
                                                        <span th:text="${ticket.categoria}"></span>
                                                    </span>
                                                </div>
                                                <span class="ticket-count"><span id="ticketCountBadge">1</span> ticket</span>
                                            </div>
                                            <ul class="ticket-list" id="ticketList">
                                                <li class="ticket-item">
                                                    <span class="ticket-id" th:text="${ticket.codigo}">TIC68428073</span>:
                                                    <span class="ticket-title" th:text="${ticket.titulo}">Solicitud de nueva funcionalidad para reportes</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline" onclick="closeAssignTicketsModal()">
                                        Cancelar
                                    </button>
                                    <button type="button" 
                                            class="btn btn-primary" 
                                            id="confirmAssignBtn" 
                                            disabled>
                                        Confirmar Asignación
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal para confirmar reapertura del ticket -->
                        <div class="modal-overlay" id="reabrirTicketModal">
                            <div class="modal">
                                <div class="modal-header">
                                    <h2 class="modal-title">Confirmar Reapertura del Ticket</h2>
                                </div>
                                <form th:action="@{/tickets/reabrir/{id}(id=${ticket.idTicket})}" method="POST">
                                    <div class="modal-body">
                                        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                                        <div>
                                            <p>¿Está seguro que desea reabrir este ticket? El estado cambiará a "Pendiente".</p>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closeReabrirTicketModal()">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Reabrir Ticket</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Modal para confirmar la desactivación del ticket -->
                        <div class="modal-overlay" id="deactivateTicketModalOverlay">
                            <div class="modal">
                                <div class="modal-header">
                                    <h2 class="modal-title">Confirmar Desactivación del Ticket</h2>
                                </div>
                                <div class="modal-body">
                                    <p>¿Está seguro que desea desactivar el ticket? Esta acción no se puede deshacer.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="closeDeactivateTicketModal()">Cancelar</button>
                                    <button type="button" class="btn btn-danger" onclick="confirmDeactivateTicket()">Desactivar Ticket</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </body>
</html>