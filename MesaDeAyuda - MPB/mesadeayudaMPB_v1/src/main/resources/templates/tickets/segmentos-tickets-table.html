<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/plantilla :: head}">
        <title>Centro de Soporte</title>
        <meta charset="UTF-8"/>
    </head>
    <body>
        <section th:fragment="metodosTickets">
            <div class="search-section">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Buscar por código, usuario, descripción o categoria..." id="searchInput">
                </div>
                <div class="action-buttons">
                    <button class="btn" id="assignTicketsBtn" th:classappend="${#lists.isEmpty(tickets)} ? 'hidden'" style="display: none;">
                        <i class="fa-solid fa-user-plus"></i> Asignar Ticket
                    </button>
                    <div class="export-container">
                        <button class="btn export-btn" id="exportBtn">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <div class="export-menu" id="exportMenu">
                            <div class="export-item" data-format="pdf">
                                <i class="fas fa-file-pdf"></i> PDF
                            </div>
                            <div class="export-item" data-format="excel">
                                <i class="fas fa-file-excel"></i> Excel
                            </div>
                            <div class="export-item" data-format="csv">
                                <i class="fas fa-file-csv"></i> CSV
                            </div>
                            <div class="export-item" data-format="rtf">
                                <i class="fas fa-file-word"></i> RTF
                            </div>
                        </div>
                    </div>
                    <button class="btn" id="filterBtn">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>
        </section>

        <section th:fragment="listadoTickets">
            <div class="table-header">
                <div class="pagination-left">
                    <span>Mostrar</span>
                    <select id="recordsPerPage" class="records-select">
                        <option value="15" th:selected="${pageSize == 15}">15</option>
                        <option value="30" th:selected="${pageSize == 30}">30</option>
                        <option value="50" th:selected="${pageSize == 50}">50</option>
                        <option value="100" th:selected="${pageSize == 100}">100</option>
                        <option value="200" th:selected="${pageSize == 200}">200</option>
                        <option value="500" th:selected="${pageSize == 500}">500</option>
                        <option value="1000" th:selected="${pageSize == 1000}">1000</option>
                    </select>
                    <span>registros por página</span>
                </div>
                <div class="pagination-center">
                    <span id="pageInfo" th:text="'Mostrando ' + ${start} + ' a ' + ${end} + ' de ' + ${totalItems} + ' registros'">
                        Mostrando 1 a 20 de 57 registros
                    </span>
                </div>
                <div class="btn-refresh-container" id="btnRefreshMessages" title="Actualizar Tabla">
                    <button class="btn-refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" 
                            th:onclick="'window.location.href=\'' + @{/tickets/listado(page=0,size=${pageSize})} + '\''"
                            th:disabled="${currentPage == 0}">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="pagination-btn" 
                            th:onclick="'window.location.href=\'' + @{/tickets/listado(page=${currentPage-1},size=${pageSize})} + '\''"
                            th:disabled="${currentPage == 0}">
                        <i class="fas fa-angle-left"></i>
                    </button>
                    <div class="page-numbers" id="pageNumbers">
                        <button th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                                th:class="'page-number ' + ${pageNum == currentPage ? 'active' : ''}"
                                th:onclick="'window.location.href=\'' + @{/tickets/listado(page=${pageNum},size=${pageSize})} + '\''"
                                th:text="${pageNum + 1}">1</button>
                    </div>
                    <button class="pagination-btn" 
                            th:onclick="'window.location.href=\'' + @{/tickets/listado(page=${currentPage+1},size=${pageSize})} + '\''"
                            th:disabled="${currentPage >= totalPages - 1}">
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="pagination-btn" 
                            th:onclick="'window.location.href=\'' + @{/tickets/listado(page=${totalPages-1},size=${pageSize})} + '\''"
                            th:disabled="${currentPage >= totalPages - 1}">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="tickets-table table-resizable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="checkbox-custom" id="selectAll">
                                    <label for="selectAll" class="checkbox-label"></label>
                                    <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Código</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="codigo"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Apertura</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="fechaApertura"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Breve Descripción</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="titulo"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Solicitante</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="solicitante"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Prioridad</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="prioridad"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Estado</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="estado"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Categoría</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="categoria"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Asignado para</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="asignadoPara"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                            <th>
                                <div class="header-content">
                                    <div class="header-text">Actualizado</div>
                                    <div class="sort-icons">
                                        <i class="fas fa-sort sort-icon" data-column="fechaActualizacion"></i>
                                    </div>
                                </div>
                                <div class="resizer"></div>
                            </th>
                        </tr>
                    </thead>

                    <thead id="filterRow" class="filter-row" style="display: none;">
                        <tr>
                            <th>
                                <button id="clearFilters" class="clear-filters-btn">
                                    <i class="fas fa-arrow-rotate-right"></i>
                                </button>
                            </th>
                            <th><input type="text" placeholder="Buscar..." data-column="codigo"></th>
                            <th>
                                <div class="date-filter-container">
                                    <div class="date-filter-dropdown">
                                        <span class="date-filter-label">Fecha</span>
                                        <i class="fas fa-calendar-alt date-filter-icon"></i>
                                    </div>
                                    <div class="date-filter-popup">
                                        <div class="date-filter-header">
                                            <span>Desde:</span>
                                            <input type="text" id="fechaFromApertura" class="date-filter-input" placeholder="dd/mm/yyyy">
                                            <span>Hasta:</span>
                                            <input type="text" id="fechaToApertura" class="date-filter-input" placeholder="dd/mm/yyyy">
                                        </div>
                                        <div class="date-filter-actions">
                                            <button class="date-filter-clear">Limpiar</button>
                                            <button class="date-filter-apply">Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </th>
                            <th><input type="text" placeholder="Buscar..." data-column="titulo"></th>
                            <th><input type="text" placeholder="Buscar..." data-column="solicitante"></th>
                            <th><input type="text" placeholder="Buscar..." data-column="prioridad"></th>
                            <th><input type="text" placeholder="Buscar..." data-column="estado"></th>
                            <th><input type="text" placeholder="Buscar..." data-column="categoria"></th>
                            <th><input type="text" placeholder="Buscar..." data-column="asignadoPara"></th>
                            <th>
                                <div class="date-filter-container">
                                    <div class="date-filter-dropdown">
                                        <span class="date-filter-label">Fecha</span>
                                        <i class="fas fa-calendar-alt date-filter-icon"></i>
                                    </div>
                                    <div class="date-filter-popup">
                                        <div class="date-filter-header">
                                            <span>Desde:</span>
                                            <input type="text" id="fechaFromActualizado" class="date-filter-input" placeholder="dd/mm/yyyy">
                                            <span>Hasta:</span>
                                            <input type="text" id="fechaToActualizado" class="date-filter-input" placeholder="dd/mm/yyyy">
                                        </div>
                                        <div class="date-filter-actions">
                                            <button class="date-filter-clear">Limpiar</button>
                                            <button class="date-filter-apply">Aplicá</button>
                                        </div>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="ticket : ${tickets}">
                            <td>
                                <input type="checkbox" class="checkbox-custom ticket-checkbox" 
                                       th:data-id="${ticket.idTicket}" id="ticket_${ticket.idTicket}">
                                <label th:for="'ticket_' + ${ticket.idTicket}" class="checkbox-label"></label>
                            </td>
                            <td>
                                <a th:href="@{/tickets/manager/{id}(id=${ticket.idTicket})}" 
                                   class="ticket-link" th:text="${ticket.codigo}">(Codigo)</a>
                            </td>
                            <td>
                                <span th:text="${#dates.format(ticket.fechaApertura, 'dd/MM/yyyy')}">(Fecha)</span><br>
                                <span th:text="${#dates.format(ticket.fechaApertura, 'HH:mm:ss')}">(Hora)</span>
                            </td>
                            <td th:text="${ticket.titulo}" style="text-align: left;">(Titulo)</td>
                            <td th:text="${ticket.solicitante.nombre + ' ' + ticket.solicitante.apellido}">(Solicitante)</td>
                            <td>
                                <span th:class="'badge badge-' + ${ticket.prioridad == 'Sin Asignar' ? 'sin-asignar' : #strings.toLowerCase(ticket.prioridad)}"
                                      th:text="${ticket.prioridad == 'Sin Asignar' ? 'Sin Asignar' : ticket.prioridad}">
                                    (Prioridad)
                                </span>
                            </td>
                            <td>
                                <span th:class="'badge badge-' + ${#strings.toLowerCase(ticket.estado)}" 
                                      th:text="${ticket.estado}">(Estado)</span>
                            </td>
                            <td th:text="${ticket.categoria}">(Categoria)</td>
                            <td>
                                <span th:if="${ticket.asignadoPara == null}" 
                                      class="badge badge-sin-asignar">Sin Asignar</span>
                                <span th:unless="${ticket.asignadoPara == null}" 
                                      th:text="${ticket.asignadoPara.nombre + ' ' + ticket.asignadoPara.apellido}">(Colaborador)</span>
                            </td>
                            <td>
                                <span th:text="${#dates.format(ticket.fechaActualizacion, 'dd/MM/yyyy')}">(Fecha)</span><br>
                                <span th:text="${#dates.format(ticket.fechaActualizacion, 'HH:mm:ss')}">(Hora)</span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(tickets)}">
                            <td colspan="10" class="text-center">No hay tickets registrados</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="modal-overlay" id="assignTicketsModalOverlay">
                <div class="modal assign-modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Asignar Tickets</h2>
                        <p class="modal-description">Seleccione un soportista o administrador para asignar los tickets.</p>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label" for="soportistaSearchInput">Buscar soportista/administrador</label>
                            <div class="search-input-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" 
                                       class="form-control search-input" 
                                       id="soportistaSearchInput" 
                                       placeholder="Buscar por nombre, código o rol..."
                                       autocomplete="off">
                                <button type="button" 
                                        class="clear-search-btn" 
                                        id="clearSearchBtn" 
                                        title="Limpiar búsqueda">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="floating-results-container" id="floatingResultsContainer">
                            <div id="loadingMessage" class="loading-message" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Cargando colaboradores...</span>
                            </div>

                            <div id="errorMessage" class="error-message" style="display: none;">
                                Error al cargar los colaboradores
                            </div>

                            <div class="floating-results-list" id="soportistasList">
                            </div>
                        </div>

                        <div class="ticket-summary-section">
                            <div class="section-header">
                                <i class="fas fa-ticket-alt"></i>
                                <span>Resumen de tickets (<span id="ticketCountBadge">0</span> ticket)</span>
                            </div>
                            <div class="ticket-group">
                                <ul class="ticket-list" id="ticketList"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeAssignTicketsModal()">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirmAssignBtn" disabled>Confirmar Asignación</button>
                    </div>
                </div>
            </div>
        </section>
    </body>
</html>