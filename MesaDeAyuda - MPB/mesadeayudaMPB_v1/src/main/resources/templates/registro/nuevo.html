<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/plantilla :: head}">
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Mesa de Ayuda</title>
                </head>
                <body class="body-registro">
                    <div class="registro-container">
                        <div class="registro-form">
                            <div class="registro-left">
                                <h1 class="h1-registro">Registrese</h1>
                                <p class="p-registro">Bienvenido a su Centro de Soporte</p>
                                <div class="registro-illustration"></div>
                                <p class="registro-description">Registrate con nosotros para acceder a nuestro servicio de soporte en línea y obtener asistencia personalizada por nuestra de la institución.</p>
                            </div>
                            <div class="registro-right">
                                <div class="municipalidad-logo"></div>
                                <form id="registroForm" th:action="@{/registro/nuevo}" method="post" class="form-elements-registro">
                                    <div class="input-group-registro">
                                        <label for="nombre">Nombre(s)</label>
                                        <input type="text" id="nombre" name="nombre" placeholder="Ingrese su nombre..." required>
                                    </div>
                                    <div class="input-group-registro">
                                        <label for="apellidos">Apellido</label>
                                        <input type="text" id="apellido" name="apellido" placeholder="Ingrese sus apellidos..." required>
                                    </div>
                                    <div class="input-group-registro">
                                        <label for="departamento">Departamento</label>
                                        <select id="departamento" name="departamento" required>
                                            <option th:each="departamento : ${departamentos}" 
                                                    th:value="${departamento.nombre}" 
                                                    th:text="${departamento.nombre}"></option>
                                        </select>
                                    </div>
                                    <div class="input-group-registro">
                                        <label for="email">Correo Electrónico</label>
                                        <input type="email" id="email" name="correoElectronico" placeholder="Ingrese su correo institucional..." required>
                                    </div>
                                    <div class="input-group-registro">
                                        <label for="password">Contraseña</label>
                                        <input type="password" id="password" name="contrasena" placeholder="Ingrese una nueva contraseña..." required>
                                    </div>
                                    <div class="input-group-registro">
                                        <label for="confirm-password">Confirmar Contraseña</label>
                                        <input type="password" id="confirm-password" name="confirm-password" placeholder="Ingrese nuevamente la contraseña..." required>
                                    </div>

                                    <button type="submit" class="btn-crear-cuenta">Crear Cuenta</button>
                                    <a href="/login" class="link-ya-tengo-cuenta">Ya tengo una cuenta</a>
                                </form>     
                            </div>
                        </div>
                    </div>

                    <!-- Contenedor para los botones de prueba -->
                    <div style="text-align: center; margin-top: 50px;">
                        <button onclick="showToast('warning')">Mostrar Alerta</button>
                        <button onclick="showToast('error')">Mostrar Error</button>
                    </div>

                    <!-- Toast de Alerta (Amarillo) -->
                    <div id="toast-warning" class="toast-modal toast-warning">
                        <div class="toast-content">
                            <p class="toast-message">
                                <i class="toast-icon fa-solid fa-triangle-exclamation"></i>
                                <span>"Mensaje generico..."</span>
                            </p>
                            <span class="toast-close" onclick="closeToast('warning')">
                                <i class="fa-solid fa-xmark"></i>
                            </span>
                        </div>
                    </div>

                    <!-- Toast de Error (Rojo) -->
                    <div id="toast-error" class="toast-modal toast-error">
                        <div class="toast-content">
                            <p class="toast-message">
                                <i class="toast-icon fa-solid fa-server"></i>
                                <span>"Mensaje generico..."</span>
                            </p>
                            <span class="toast-close" onclick="closeToast('error')">
                                <i class="fa-solid fa-xmark"></i>
                            </span>
                        </div>
                    </div>


                    <script>
                        //Para mostrar los modals del formulario de registro
                        $("#registroForm").on('submit', function (event) {
                            event.preventDefault();

                            const password = $("#password").val();
                            const confirmPassword = $("#confirm-password").val();
                            const email = $("#email").val();

                            if (password !== confirmPassword) {
                                showToast('error', "Las contraseñas no coinciden. Por favor, inténtelo de nuevo.");
                                return;
                            }

                            const formData = new FormData(this);

                            $.ajax({
                                url: '/registro/nuevo',
                                method: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: function (response) {
                                    if (response.success) {
                                        window.location.href = response.redirectUrl;
                                    } else if (response.error) {
                                        // Si el error es que el correo ya está registrado, muestra el modal amarillo
                                        if (response.error.includes("ya está registrado")) {
                                            // Cambia el mensaje a "El correo ya se encuentra registrado"
                                            showToast('warning', "El correo ya se encuentra registrado.");
                                        } else {
                                            showToast('error', response.error);
                                        }
                                    }
                                },
                                error: function (xhr) {
                                    let errorMessage = "Error al procesar el registro.";

                                    // Intenta parsear la respuesta JSON
                                    try {
                                        const jsonResponse = JSON.parse(xhr.responseText);
                                        if (jsonResponse && jsonResponse.error) {
                                            errorMessage = jsonResponse.error;
                                            // Si el error es que el correo ya está registrado, muestra el modal amarillo
                                            if (errorMessage.includes("ya está registrado")) {
                                                // Cambia el mensaje a "El correo ya se encuentra registrado"
                                                showToast('warning', "El correo ya se encuentra registrado.");
                                            } else {
                                                showToast('error', errorMessage);
                                            }
                                        }
                                    } catch (e) {
                                        // Si no es JSON, verifica si xhr.responseJSON existe
                                        if (xhr.responseJSON && xhr.responseJSON.error) {
                                            errorMessage = xhr.responseJSON.error;
                                            // Si el error es que el correo ya está registrado, muestra el modal amarillo
                                            if (errorMessage.includes("ya está registrado")) {
                                                // Cambia el mensaje a "El correo ya se encuentra registrado"
                                                showToast('warning', "El correo ya se encuentra registrado.");
                                            } else {
                                                showToast('error', errorMessage);
                                            }
                                        } else {
                                            showToast('error', errorMessage);
                                        }
                                    }
                                }
                            });
                        });

// Función para mostrar toast con mensaje dinámico
                        function showToast(type, message) {
                            // Actualiza el mensaje en el toast
                            $(`#toast-${type} .toast-message span`).text(message);

                            // Muestra el toast
                            $(`#toast-${type}`).css('display', 'block');

                            // Cierra automáticamente después de 5 segundos
                            setTimeout(function () {
                                closeToast(type);
                            }, 20000);
                        }

                        function closeToast(type) {
                            $(`#toast-${type}`).css('display', 'none');
                        }
                    </script>

                    <footer>
                        © 2024 Municipalidad de Barva. Todos los derechos reservados.
                    </footer>
                </body>
                </html>